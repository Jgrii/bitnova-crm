<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitNova CRM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="dashboardcss.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-users"></i>
                BitNova CRM
            </div>
            <div class="user-info">
                <span id="userEmail">Betöltés...</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Kilépés
                </button>
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <a href="#" class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-chart-pie"></i> Áttekintés
                </a>
                <a href="#" class="nav-item" onclick="showSection('customers')">
                    <i class="fas fa-users"></i> Ügyfelek
                </a>
                <a href="#" class="nav-item" onclick="showSection('leads')">
                    <i class="fas fa-user-plus"></i> Leadek
                </a>
                <a href="#" class="nav-item" onclick="showSection('deals')">
                    <i class="fas fa-handshake"></i> Üzletek
                </a>
                <a href="#" class="nav-item" onclick="showSection('tasks')">
                    <i class="fas fa-tasks"></i> Feladatok
                </a>
                <a href="#" class="nav-item" onclick="showSection('reports')">
                    <i class="fas fa-chart-bar"></i> Jelentések
                </a>
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-arrow-left"></i> Vissza
                </a>
            </nav>

            <main class="content">
                <!-- Dashboard szekció -->
                <div id="dashboard" class="section">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">CRM Áttekintés</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-users" style="color: #667eea;"></i>
                                    Összes ügyfél
                                </div>
                            </div>
                            <div class="card-value" id="totalCustomers">Betöltés...</div>
                            <div class="card-subtitle" id="customersSummary">Betöltés...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-user-plus" style="color: #28a745;"></i>
                                    Aktív leadek
                                </div>
                            </div>
                            <div class="card-value" id="activeLeads">Betöltés...</div>
                            <div class="card-subtitle" id="leadsSummary">Betöltés...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-handshake" style="color: #17a2b8;"></i>
                                    Nyitott üzletek
                                </div>
                            </div>
                            <div class="card-value" id="openDeals">Betöltés...</div>
                            <div class="card-subtitle" id="dealsSummary">Betöltés...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-euro-sign" style="color: #ffc107;"></i>
                                    Havi bevétel
                                </div>
                            </div>
                            <div class="card-value" id="monthlyRevenue">Betöltés...</div>
                            <div class="card-subtitle" id="revenueSummary">Betöltés...</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 30px;">
                        <div class="table-container">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Legutóbbi ügyfelek</h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Név</th>
                                        <th>Email</th>
                                        <th>Státusz</th>
                                    </tr>
                                </thead>
                                <tbody id="recentCustomersTable">
                                    <tr>
                                        <td>Betöltés...</td>
                                        <td>Betöltés...</td>
                                        <td><span class="status paid">Betöltés...</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="table-container">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Sürgős feladatok</h3>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Feladat</th>
                                        <th>Határidő</th>
                                        <th>Prioritás</th>
                                    </tr>
                                </thead>
                                <tbody id="urgentTasksTable">
                                    <tr>
                                        <td>Betöltés...</td>
                                        <td>Betöltés...</td>
                                        <td><span class="status overdue">Betöltés...</span></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Ügyfelek szekció -->
                <div id="customers" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Ügyfelek</h2>
                        <button class="btn btn-primary" onclick="openCustomerModal()">
                            <i class="fas fa-plus"></i> Új ügyfél
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Név</th>
                                    <th>Email</th>
                                    <th>Telefon</th>
                                    <th>Cég</th>
                                    <th>Státusz</th>
                                    <th>Regisztráció</th>
                                    <th>Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="customersTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status paid">Betöltés...</span></td>
                                    <td>Betöltés...</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Szerkeszt</button>
                                        <button class="btn btn-sm btn-delete">Törlés</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Leadek szekció -->
                <div id="leads" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Leadek</h2>
                        <button class="btn btn-primary" onclick="openLeadModal()">
                            <i class="fas fa-plus"></i> Új lead
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Név</th>
                                    <th>Email</th>
                                    <th>Forrás</th>
                                    <th>Értékelés</th>
                                    <th>Státusz</th>
                                    <th>Létrehozva</th>
                                    <th>Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="leadsTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                    <td>Betöltés...</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Szerkeszt</button>
                                        <button class="btn btn-sm btn-secondary">Konvertál</button>
                                        <button class="btn btn-sm btn-delete">Törlés</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Üzletek szekció -->
                <div id="deals" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Üzletek</h2>
                        <button class="btn btn-primary" onclick="openDealModal()">
                            <i class="fas fa-plus"></i> Új üzlet
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Üzlet neve</th>
                                    <th>Ügyfél</th>
                                    <th>Érték</th>
                                    <th>Státusz</th>
                                    <th>Lezárás dátuma</th>
                                    <th>Valószínűség</th>
                                    <th>Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="dealsTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Szerkeszt</button>
                                        <button class="btn btn-sm btn-delete">Törlés</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Feladatok szekció -->
                <div id="tasks" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Feladatok</h2>
                        <button class="btn btn-primary" onclick="openTaskModal()">
                            <i class="fas fa-plus"></i> Új feladat
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Feladat</th>
                                    <th>Kapcsolat</th>
                                    <th>Határidő</th>
                                    <th>Prioritás</th>
                                    <th>Státusz</th>
                                    <th>Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="tasksTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status overdue">Betöltés...</span></td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Szerkeszt</button>
                                        <button class="btn btn-sm btn-secondary">Befejez</button>
                                        <button class="btn btn-sm btn-delete">Törlés</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Jelentések szekció -->
                <div id="reports" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Jelentések</h2>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                        <div class="table-container">
                            <h3 style="margin-bottom: 15px;">Értékesítési teljesítmény</h3>
                            <div style="padding: 20px;">
                                <div style="margin-bottom: 15px;">
                                    <strong>Ez a hónap:</strong> <span id="thisMonthSales">0 Ft</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>Előző hónap:</strong> <span id="lastMonthSales">0 Ft</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>Változás:</strong> <span id="salesChange">0%</span>
                                </div>
                            </div>
                        </div>

                        <div class="table-container">
                            <h3 style="margin-bottom: 15px;">Lead konverziós arány</h3>
                            <div style="padding: 20px;">
                                <div style="margin-bottom: 15px;">
                                    <strong>Összes lead:</strong> <span id="totalLeadsReport">0</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>Konvertált:</strong> <span id="convertedLeads">0</span>
                                </div>
                                <div style="margin-bottom: 15px;">
                                    <strong>Konverziós arány:</strong> <span id="conversionRate">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="table-container" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">Top 10 ügyfél bevétel szerint</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Ügyfél</th>
                                    <th>Email</th>
                                    <th>Összes bevétel</th>
                                    <th>Utolsó vásárlás</th>
                                </tr>
                            </thead>
                            <tbody id="topCustomersTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Ügyfél modal -->
    <div id="customerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="customerModalTitle">Új ügyfél</h3>
                <span class="close" onclick="closeCustomerModal()">&times;</span>
            </div>
            <form id="customerForm">
                <div class="form-group">
                    <label for="customerName">Teljes név *</label>
                    <input type="text" id="customerName" required>
                </div>
                <div class="form-group">
                    <label for="customerEmail">Email cím *</label>
                    <input type="email" id="customerEmail" required>
                </div>
                <div class="form-group">
                    <label for="customerPhone">Telefon</label>
                    <input type="tel" id="customerPhone">
                </div>
                <div class="form-group">
                    <label for="customerCompany">Cég neve</label>
                    <input type="text" id="customerCompany">
                </div>
                <div class="form-group">
                    <label for="customerStatus">Státusz</label>
                    <select id="customerStatus">
                        <option value="active">Aktív</option>
                        <option value="inactive">Inaktív</option>
                        <option value="prospect">Potenciális</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="customerNotes">Megjegyzések</label>
                    <textarea id="customerNotes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeCustomerModal()">Mégse</button>
                    <button type="submit" class="btn btn-primary">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lead modal -->
    <div id="leadModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="leadModalTitle">Új lead</h3>
                <span class="close" onclick="closeLeadModal()">&times;</span>
            </div>
            <form id="leadForm">
                <div class="form-group">
                    <label for="leadName">Teljes név *</label>
                    <input type="text" id="leadName" required>
                </div>
                <div class="form-group">
                    <label for="leadEmail">Email cím *</label>
                    <input type="email" id="leadEmail" required>
                </div>
                <div class="form-group">
                    <label for="leadPhone">Telefon</label>
                    <input type="tel" id="leadPhone">
                </div>
                <div class="form-group">
                    <label for="leadSource">Forrás</label>
                    <select id="leadSource">
                        <option value="website">Weboldal</option>
                        <option value="social">Közösségi média</option>
                        <option value="referral">Ajánlás</option>
                        <option value="advertising">Hirdetés</option>
                        <option value="cold_call">Hideg hívás</option>
                        <option value="other">Egyéb</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="leadRating">Értékelés</label>
                    <select id="leadRating">
                        <option value="cold">Hideg</option>
                        <option value="warm">Meleg</option>
                        <option value="hot">Forró</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="leadNotes">Megjegyzések</label>
                    <textarea id="leadNotes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeLeadModal()">Mégse</button>
                    <button type="submit" class="btn btn-primary">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Üzlet modal -->
    <div id="dealModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="dealModalTitle">Új üzlet</h3>
                <span class="close" onclick="closeDealModal()">&times;</span>
            </div>
            <form id="dealForm">
                <div class="form-group">
                    <label for="dealName">Üzlet neve *</label>
                    <input type="text" id="dealName" required>
                </div>
                <div class="form-group">
                    <label for="dealCustomer">Ügyfél</label>
                    <select id="dealCustomer">
                        <option value="">Válasszon ügyfelet</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dealValue">Érték (Ft) *</label>
                    <input type="number" id="dealValue" required min="0">
                </div>
                <div class="form-group">
                    <label for="dealStage">Státusz</label>
                    <select id="dealStage">
                        <option value="qualification">Kvalifikáció</option>
                        <option value="proposal">Ajánlat</option>
                        <option value="negotiation">Tárgyalás</option>
                        <option value="closed_won">Lezárt - Nyert</option>
                        <option value="closed_lost">Lezárt - Vesztett</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="dealProbability">Valószínűség (%)</label>
                    <input type="number" id="dealProbability" min="0" max="100" value="50">
                </div>
                <div class="form-group">
                    <label for="dealCloseDate">Várható lezárás</label>
                    <input type="date" id="dealCloseDate">
                </div>
                <div class="form-group">
                    <label for="dealNotes">Megjegyzések</label>
                    <textarea id="dealNotes" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDealModal()">Mégse</button>
                    <button type="submit" class="btn btn-primary">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Feladat modal -->
    <div id="taskModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="taskModalTitle">Új feladat</h3>
                <span class="close" onclick="closeTaskModal()">&times;</span>
            </div>
            <form id="taskForm">
                <div class="form-group">
                    <label for="taskTitle">Feladat címe *</label>
                    <input type="text" id="taskTitle" required>
                </div>
                <div class="form-group">
                    <label for="taskContact">Kapcsolat</label>
                    <select id="taskContact">
                        <option value="">Válasszon kapcsolatot</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskDueDate">Határidő</label>
                    <input type="datetime-local" id="taskDueDate">
                </div>
                <div class="form-group">
                    <label for="taskPriority">Prioritás</label>
                    <select id="taskPriority">
                        <option value="low">Alacsony</option>
                        <option value="medium">Közepes</option>
                        <option value="high">Magas</option>
                        <option value="urgent">Sürgős</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskType">Típus</label>
                    <select id="taskType">
                        <option value="call">Hívás</option>
                        <option value="email">Email</option>
                        <option value="meeting">Találkozó</option>
                        <option value="follow_up">Követés</option>
                        <option value="other">Egyéb</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="taskDescription">Leírás</label>
                    <textarea id="taskDescription" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeTaskModal()">Mégse</button>
                    <button type="submit" class="btn btn-primary">Mentés</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-firestore-compat.min.js"></script>

    <script>
        // Firebase konfiguráció
       const firebaseConfig = {
            apiKey: "AIzaSyAXnAo-7BF6iKjNzYr0uoJbhlpCWNaS9s4",
            authDomain: "bitnova-backend.firebaseapp.com",
            projectId: "bitnova-backend",
            storageBucket: "bitnova-backend.firebasestorage.app",
            messagingSenderId: "312941837204",
            appId: "1:312941837204:web:f6e3ff0d44cab13f30ed81",
            measurementId: "G-VBW8LX8LDE"
          };

        // Firebase inicializálás
        try {
            firebase.initializeApp(firebaseConfig);
            console.log('✅ Firebase inicializálva');
        } catch (error) {
            console.error('❌ Firebase inicializálási hiba:', error);
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // Authentikáció figyelése
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                console.log('✅ Sikeres authentikáció:', user.email);
                document.getElementById('userEmail').textContent = user.email;
                await initializeCRMData(user.uid);
                await loadCRMData(user.uid);
                setupCRMRealTimeListeners(user.uid);
            } else {
                console.log('❌ Nincs bejelentkezett felhasználó');
                window.location.href = 'bejelentkezes.html';
            }
        });

        // Kijelentkezés
        function logout() {
            auth.signOut().then(() => {
                window.location.href = 'index.html';
            });
        }

        // CRM adatok inicializálása
        async function initializeCRMData(userId) {
            try {
                // Ellenőrizzük, hogy vannak-e már CRM adatok
                const customersSnapshot = await db.collection('crm_customers').where('userId', '==', userId).limit(1).get();
                
                if (customersSnapshot.empty) {
                    console.log('CRM adatok inicializálása...');
                    await createDefaultCRMData(userId);
                }
            } catch (error) {
                console.error('CRM inicializálási hiba:', error);
            }
        }

        // Alapértelmezett CRM adatok létrehozása
        async function createDefaultCRMData(userId) {
            // Ügyfelek
            const customers = [
                {
                    userId: userId,
                    name: 'Nagy Péter',
                    email: 'nagy.peter@example.com',
                    phone: '+36 20 123 4567',
                    company: 'TechSoft Kft.',
                    status: 'active',
                    notes: 'VIP ügyfél, prémium szolgáltatásokat használ',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    totalRevenue: 450000
                },
            ];
            // Leadek példaadatok
            const leads = [
                {
                    userId: userId,
                    name: 'Tóth Eszter',
                    email: 'toth.eszter@company.com',
                    phone: '+36 30 123 4567',
                    source: 'website',
                    rating: 'hot',
                    status: 'new',
                    notes: 'Weboldal építést kért',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    userId: userId,
                    name: 'Molnár Zoltán',
                    email: 'molnar.zoltan@firm.hu',
                    phone: '+36 20 987 6543',
                    source: 'referral',
                    rating: 'warm',
                    status: 'contacted',
                    notes: 'Ajánlásból érkezett',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];
            
            // Üzletek példaadatok
            const deals = [
                {
                    userId: userId,
                    name: 'TechSoft prémium csomag',
                    customerId: '', // majd customer ID-val töltjük fel
                    customerName: 'Nagy Péter',
                    value: 850000,
                    stage: 'proposal',
                    probability: 75,
                    closeDate: new Date('2025-07-15'),
                    notes: 'Árról még egyeztetni kell',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    userId: userId,
                    name: 'WebStudio maintenance',
                    customerId: '',
                    customerName: 'Szabó Anna',
                    value: 120000,
                    stage: 'negotiation',
                    probability: 60,
                    closeDate: new Date('2025-06-30'),
                    notes: 'Éves karbantartási szerződés',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];
            
            // Feladatok példaadatok
            const tasks = [
                {
                    userId: userId,
                    title: 'Nagy Péter felhívása',
                    contactName: 'Nagy Péter',
                    dueDate: new Date('2025-06-20T10:00:00'),
                    priority: 'high',
                    type: 'call',
                    status: 'pending',
                    description: 'Ajánlat egyeztetése',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                },
                {
                    userId: userId,
                    title: 'Molnár Zoltán email küldése',
                    contactName: 'Molnár Zoltán',
                    dueDate: new Date('2025-06-19T14:00:00'),
                    priority: 'medium',
                    type: 'email',
                    status: 'pending',
                    description: 'Bemutatkozó email és ajánlat',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                }
            ];
            
            // Adatok mentése Firestore-ba
            for (const customer of customers) {
                await db.collection('crm_customers').add(customer);
            }
            for (const lead of leads) {
                await db.collection('crm_leads').add(lead);
            }
            for (const deal of deals) {
                await db.collection('crm_deals').add(deal);
            }
            for (const task of tasks) {
                await db.collection('crm_tasks').add(task);
            }

        async function loadCRMData(userId) {
            try {
                // Dashboard statisztikák betöltése
                await loadDashboardStats(userId);
                
                // Táblázatok betöltése
                await loadCustomersTable(userId);
                await loadLeadsTable(userId);
                await loadDealsTable(userId);
                await loadTasksTable(userId);
                await loadReports(userId);
                
            } catch (error) {
                console.error('Adatbetöltési hiba:', error);
            }
        }
        
        async function loadDashboardStats(userId) {
            // Ügyfelek száma
            const customersSnapshot = await db.collection('crm_customers').where('userId', '==', userId).get();
            document.getElementById('totalCustomers').textContent = customersSnapshot.size;
            document.getElementById('customersSummary').textContent = `${customersSnapshot.docs.filter(doc => doc.data().status === 'active').length} aktív`;
        
            // Leadek száma
            const leadsSnapshot = await db.collection('crm_leads').where('userId', '==', userId).where('status', '!=', 'converted').get();
            document.getElementById('activeLeads').textContent = leadsSnapshot.size;
            document.getElementById('leadsSummary').textContent = `${leadsSnapshot.docs.filter(doc => doc.data().rating === 'hot').length} forró lead`;
        
            // Nyitott üzletek
            const dealsSnapshot = await db.collection('crm_deals').where('userId', '==', userId).where('stage', 'not-in', ['closed_won', 'closed_lost']).get();
            document.getElementById('openDeals').textContent = dealsSnapshot.size;
            const totalDealValue = dealsSnapshot.docs.reduce((sum, doc) => sum + (doc.data().value || 0), 0);
            document.getElementById('dealsSummary').textContent = `${formatCurrency(totalDealValue)} összérték`;
        
            // Havi bevétel
            const currentMonth = new Date();
            const firstDayOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
            const wonDealsSnapshot = await db.collection('crm_deals')
                .where('userId', '==', userId)
                .where('stage', '==', 'closed_won')
                .where('closeDate', '>=', firstDayOfMonth)
                .get();
            
            const monthlyRevenue = wonDealsSnapshot.docs.reduce((sum, doc) => sum + (doc.data().value || 0), 0);
            document.getElementById('monthlyRevenue').textContent = formatCurrency(monthlyRevenue);
            document.getElementById('revenueSummary').textContent = `${wonDealsSnapshot.size} lezárt üzlet`;
        }

        async function loadCustomersTable(userId) {
            const snapshot = await db.collection('crm_customers').where('userId', '==', userId).orderBy('createdAt', 'desc').get();
            const tbody = document.getElementById('customersTable');
            const recentTbody = document.getElementById('recentCustomersTable');
            
            tbody.innerHTML = '';
            recentTbody.innerHTML = '';
            
            snapshot.docs.forEach((doc, index) => {
                const customer = doc.data();
                const row = createCustomerRow(doc.id, customer);
                tbody.appendChild(row);
                
                // Első 5 a recent táblába
                if (index < 5) {
                    const recentRow = createRecentCustomerRow(customer);
                    recentTbody.appendChild(recentRow);
                }
            });
        }
        
        function createCustomerRow(id, customer) {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${customer.name}</td>
                <td>${customer.email}</td>
                <td>${customer.phone || '-'}</td>
                <td>${customer.company || '-'}</td>
                <td><span class="status ${customer.status}">${getStatusText(customer.status)}</span></td>
                <td>${formatDate(customer.createdAt?.toDate())}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editCustomer('${id}')">Szerkeszt</button>
                    <button class="btn btn-sm btn-delete" onclick="deleteCustomer('${id}')">Törlés</button>
                </td>
            `;
            return row;
        }

        // Szekció váltás
        function showSection(sectionName) {
            // Összes szekció elrejtése
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Kiválasztott szekció megjelenítése
            document.getElementById(sectionName).classList.remove('hidden');
            
            // Navigációs elemek frissítése
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Modal függvények
        function openCustomerModal(customerId = null) {
            document.getElementById('customerModal').style.display = 'flex';
            if (customerId) {
                loadCustomerForEdit(customerId);
                document.getElementById('customerModalTitle').textContent = 'Ügyfél szerkesztése';
            } else {
                document.getElementById('customerForm').reset();
                document.getElementById('customerModalTitle').textContent = 'Új ügyfél';
            }
        }
        
        function closeCustomerModal() {
            document.getElementById('customerModal').style.display = 'none';
        }
        
        // Similar functions for other modals...


        // Form submit handlerek
        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await saveCustomer();
        });
        
        async function saveCustomer() {
            const formData = {
                userId: auth.currentUser.uid,
                name: document.getElementById('customerName').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                company: document.getElementById('customerCompany').value,
                status: document.getElementById('customerStatus').value,
                notes: document.getElementById('customerNotes').value,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                totalRevenue: 0
            };
            
            try {
                await db.collection('crm_customers').add(formData);
                closeCustomerModal();
                await loadCustomersTable(auth.currentUser.uid);
                await loadDashboardStats(auth.currentUser.uid);
            } catch (error) {
                console.error('Mentési hiba:', error);
                alert('Hiba történt a mentés során!');
            }
        }
        
        async function deleteCustomer(customerId) {
            if (confirm('Biztosan törölni szeretné ezt az ügyfelet?')) {
                try {
                    await db.collection('crm_customers').doc(customerId).delete();
                    await loadCustomersTable(auth.currentUser.uid);
                    await loadDashboardStats(auth.currentUser.uid);
                } catch (error) {
                    console.error('Törlési hiba:', error);
                }
            }
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('hu-HU', {
                style: 'currency',
                currency: 'HUF'
            }).format(amount);
        }
        
        function formatDate(date) {
            if (!date) return '-';
            return new Intl.DateTimeFormat('hu-HU').format(date);
        }
        
        function getStatusText(status) {
            const statusMap = {
                'active': 'Aktív',
                'inactive': 'Inaktív',
                'prospect': 'Potenciális',
                'new': 'Új',
                'contacted': 'Kapcsolatba lépve',
                'qualified': 'Kvalifikált',
                'converted': 'Konvertált'
            };
            return statusMap[status] || status;
        }
        
        // Valós idejű listener
        function setupCRMRealTimeListeners(userId) {
            // Ügyfelek változásának figyelése
            db.collection('crm_customers').where('userId', '==', userId)
                .onSnapshot(() => {
                    loadDashboardStats(userId);
                    if (!document.getElementById('customers').classList.contains('hidden')) {
                        loadCustomersTable(userId);
                    }
                });
            
            // Hasonlóan a többi kollekcióhoz...
        }
</script>
</body>
</html>
