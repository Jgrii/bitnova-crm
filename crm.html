<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitNova CRM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="dashboardcss.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-server"></i>
                BitNova CRM
            </div>
            <div class="user-info">
                <span id="userEmail">Betöltés...</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Kilépés
                </button>
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <a href="#" class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="#" class="nav-item" onclick="showSection('invoices')">
                    <i class="fas fa-file-invoice"></i> Számlák
                </a>
                <a href="#" class="nav-item" onclick="showSection('services')">
                    <i class="fas fa-cogs"></i> Szolgáltatások
                </a>
                <a href="#" class="nav-item" onclick="showSection('tickets')">
                    <i class="fas fa-ticket-alt"></i> Támogatási jegyek
                </a>
                <a href="#" class="nav-item" onclick="showSection('profile')">
                    <i class="fas fa-user"></i> Profil
                </a>
                <a href="#" class="nav-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> Beállítások
                </a>
            </nav>

            <main class="content">
                <div id="dashboard" class="section">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Áttekintés</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-file-invoice" style="color: #667eea;"></i>
                                    Számlák összesen
                                </div>
                            </div>
                            <div class="card-value" id="totalInvoices">Betöltés...</div>
                            <div class="card-subtitle" id="invoicesSummary">Betöltés...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-money-bill-wave" style="color: #28a745;"></i>
                                    Havi költség
                                </div>
                            </div>
                            <div class="card-value" id="monthlyCost">Betöltés...</div>
                            <div class="card-subtitle">Aktuális havi szolgáltatások</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-server" style="color: #17a2b8;"></i>
                                    Szolgáltatások
                                </div>
                            </div>
                            <div class="card-value" id="activeServices">Betöltés...</div>
                            <div class="card-subtitle" id="servicesSummary">Betöltés...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-ticket-alt" style="color: #ffc107;"></i>
                                    Nyitott jegyek
                                </div>
                            </div>
                            <div class="card-value" id="openTickets">Betöltés...</div>
                            <div class="card-subtitle" id="ticketsSummary">Betöltés...</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Legutóbbi tevékenységek</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Dátum</th>
                                    <th>Tevékenység</th>
                                    <th>Státusz</th>
                                </tr>
                            </thead>
                            <tbody id="activitiesTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                </tr>
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status paid">Betöltés...</span></td>
                                </tr>
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="invoices" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Számlák</h2>
                        <button class="btn btn-primary">
                            <i class="fas fa-plus"></i> Új számla
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Számlaszám</th>
                                    <th>Dátum</th>
                                    <th>Összeg</th>
                                    <th>Státusz</th>
                                    <th>Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Megtekint</button>
                                        <button class="btn btn-sm btn-secondary">Letölt</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="services" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Szolgáltatások</h2>
                    
                    <div class="dashboard-grid" id="servicesGrid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-server" style="color: #17a2b8;"></i>
                                    Betöltés...
                                </div>
                            </div>
                            <div class="card-subtitle">Betöltés...</div>
                            <div style="margin-top: 15px;">
                                <span class="status paid">Betöltés...</span>
                                <div style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                                    Betöltés...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tickets" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Támogatási jegyek</h2>
                        <button class="btn btn-primary" onclick="openNewTicketModal()">
                            <i class="fas fa-plus"></i> Új jegy
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Jegy #</th>
                                    <th>Tárgy</th>
                                    <th>Prioritás</th>
                                    <th>Státusz</th>
                                    <th>Létrehozva</th>
                                    <th>Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="ticketsTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status overdue">Betöltés...</span></td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                    <td>Betöltés...</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Megtekint</button>
                                        <button class="btn btn-sm btn-delete">Törlés</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="profile" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Profil beállítások</h2>
                    
                    <div class="table-container">
                        <form id="profileForm" style="max-width: 600px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cégnév</label>
                                <input type="text" id="companyName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email cím</label>
                                <input type="email" id="profileEmail" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Telefon</label>
                                <input type="tel" id="phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Cím</label>
                                <textarea id="address" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; height: 80px;"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Mentés</button>
                        </form>
                    </div>
                </div>

                <div id="settings" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Beállítások</h2>
                    
                    <div class="table-container">
                        <h3 style="margin-bottom: 15px;">Értesítési beállítások</h3>
                        <form id="settingsForm">
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailInvoice">
                                    Email értesítés új számláról
                                </label>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailTicket">
                                    Email értesítés támogatási jegy státusz változásról
                                </label>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="smsNotifications">
                                    SMS értesítések
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">Mentés</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Új jegy modal -->
    <div id="newTicketModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Új támogatási jegy</h3>
                <span class="close" onclick="closeNewTicketModal()">&times;</span>
            </div>
            <form id="newTicketForm">
                <div class="form-group">
                    <label for="ticketSubject">Tárgy *</label>
                    <input type="text" id="ticketSubject" required>
                </div>
                <div class="form-group">
                    <label for="ticketPriority">Prioritás *</label>
                    <select id="ticketPriority" required>
                        <option value="normal">Normál</option>
                        <option value="high">Magas</option>
                        <option value="urgent">Sürgős</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ticketCategory">Kategória</label>
                    <select id="ticketCategory">
                        <option value="technical">Technikai probléma</option>
                        <option value="billing">Számlázás</option>
                        <option value="general">Általános kérdés</option>
                        <option value="feature">Új funkció kérése</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ticketDescription">Részletes leírás *</label>
                    <textarea id="ticketDescription" rows="5" required placeholder="Írja le részletesen a problémát vagy kérését..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNewTicketModal()">Mégse</button>
                    <button type="submit" class="btn btn-primary">Jegy létrehozása</button>
                </div>
            </form>
        </div>
    </div>

        <!-- Törlés megerősítő modal -->
    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="background-color: #dc3545; color: white;">
                <h3><i class="fas fa-exclamation-triangle"></i> Jegy törlése</h3>
                <span class="close" onclick="closeDeleteConfirmModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 30px; text-align: center;">
                <i class="fas fa-trash-alt" style="font-size: 48px; color: #dc3545; margin-bottom: 20px;"></i>
                <h4 style="margin-bottom: 15px; color: #2c3e50;">Biztosan törölni szeretné?</h4>
                <p style="color: #6c757d; margin-bottom: 0;">
                    Ez a művelet visszavonhatatlan. A támogatási jegy véglegesen törlődik.
                </p>
            </div>
            <div class="modal-footer" style="gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()">
                    <i class="fas fa-times"></i> Mégse
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> Igen, törlöm
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-firestore-compat.min.js"></script>

    <script>
          const firebaseConfig = {
            apiKey: "AIzaSyAXnAo-7BF6iKjNzYr0uoJbhlpCWNaS9s4",
            authDomain: "bitnova-backend.firebaseapp.com",
            projectId: "bitnova-backend",
            storageBucket: "bitnova-backend.firebasestorage.app",
            messagingSenderId: "312941837204",
            appId: "1:312941837204:web:f6e3ff0d44cab13f30ed81",
            measurementId: "G-VBW8LX8LDE"
          };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log('✅ Firebase inicializálva');
        } catch (error) {
            console.error('❌ Firebase inicializálási hiba:', error);
            alert('Firebase inicializálási hiba: ' + error.message);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                console.log('✅ Auth persistence beállítva');
            })
            .catch((error) => {
                console.error('Auth persistence hiba:', error);
            });

        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state changed:', user);
            
            if (user) {
                console.log('✅ Sikeres authentikáció:', user.email);
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('profileEmail').value = user.email;
                
                await initializeUserData(user.uid, user.email);
                await loadUserData(user.uid);

                setupRealTimeListeners(user.uid);
                
            } else {
                console.log('❌ Nincs bejelentkezett felhasználó');
                setTimeout(() => {
                    window.location.href = 'bejelentkezes.html';
                }, 500);
            }
        }, (error) => {
            console.error('Auth state change error:', error);
            alert('Hiba az authentikáció során: ' + error.message);
        });

        function logout() {
            auth.signOut().then(() => {
                console.log('Sikeres kijelentkezés');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Kijelentkezési hiba:', error);
                alert('Hiba történt a kijelentkezés során: ' + error.message);
            });
        }

        async function initializeUserData(userId, email) {
            try {
                const userRef = db.collection('users').doc(userId);
                const doc = await userRef.get();
                
                if (!doc.exists) {
                    const defaultUserData = {
                        email: email,
                        companyName: '',
                        phone: '',
                        address: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        settings: {
                            emailInvoice: true,
                            emailTicket: true,
                            smsNotifications: false
                        }
                    };
                    
                    await userRef.set(defaultUserData);
                    console.log('✅ Új felhasználó dokumentum létrehozva');
                    
                    await createDefaultInvoices(userId);
                    await createDefaultServices(userId);
                    await createDefaultTickets(userId);
                    await createDefaultActivities(userId);
                    
                    console.log('✅ Alapértelmezett adatok létrehozva');
                }
            } catch (error) {
                console.error('Felhasználó inicializálási hiba:', error);
            }
        }

        async function createDefaultInvoices(userId) {
            const invoices = [
                {
                    userId: userId,
                    invoiceNumber: '2025-156',
                    amount: 45600,
                    status: 'pending',
                    date: firebase.firestore.Timestamp.now(),
                    description: 'Havi hosting szolgáltatás'
                },
                {
                    userId: userId,
                    invoiceNumber: '2025-155',
                    amount: 89500,
                    status: 'paid',
                    date: firebase.firestore.Timestamp.fromDate(new Date('2025-06-15')),
                    description: 'Szerver bérlés + domain'
                },
                {
                    userId: userId,
                    invoiceNumber: '2025-154',
                    amount: 23400,
                    status: 'overdue',
                    date: firebase.firestore.Timestamp.fromDate(new Date('2025-06-01')),
                    description: 'Kiegészítő szolgáltatások'
                }
            ];

            for (const invoice of invoices) {
                await db.collection('invoices').add(invoice);
            }
        }

        async function createDefaultServices(userId) {
            const services = [
                {
                    userId: userId,
                    name: 'Szerver hosting',
                    description: 'VPS szerver - 4GB RAM, 2 CPU',
                    status: 'active',
                    monthlyPrice: 45600,
                    icon: 'fas fa-server',
                    nextBilling: firebase.firestore.Timestamp.fromDate(new Date('2025-07-01'))
                },
                {
                    userId: userId,
                    name: 'Domain kezelés',
                    description: 'bitnova.hu + 2 aldomain',
                    status: 'active',
                    monthlyPrice: 12000,
                    icon: 'fas fa-globe',
                    nextBilling: firebase.firestore.Timestamp.fromDate(new Date('2025-12-15'))
                },
                {
                    userId: userId,
                    name: 'Biztonsági mentés',
                    description: 'Napi automatikus mentés',
                    status: 'active',
                    monthlyPrice: 8900,
                    icon: 'fas fa-shield-alt',
                    nextBilling: firebase.firestore.Timestamp.fromDate(new Date('2025-07-01'))
                }
            ];

            for (const service of services) {
                await db.collection('services').add(service);
            }
        }

        async function createDefaultTickets(userId) {
            const tickets = [
                {
                    userId: userId,
                    ticketNumber: 'T-2025-012',
                    subject: 'Weboldal betöltési idő optimalizálás',
                    priority: 'urgent',
                    status: 'in_progress',
                    createdAt: firebase.firestore.Timestamp.fromDate(new Date('2025-06-16'))
                },
                {
                    userId: userId,
                    ticketNumber: 'T-2025-011',
                    subject: 'Email beállítások módosítása',
                    priority: 'normal',
                    status: 'open',
                    createdAt: firebase.firestore.Timestamp.fromDate(new Date('2025-06-14'))
                }
            ];

            for (const ticket of tickets) {
                await db.collection('tickets').add(ticket);
            }
        }

        async function createDefaultActivities(userId) {
            const activities = [
                {
                    userId: userId,
                    description: 'Számla #2025-156 létrehozva',
                    type: 'invoice',
                    status: 'Függőben',
                    date: firebase.firestore.Timestamp.now()
                },
                {
                    userId: userId,
                    description: 'Szerver karbantartás befejezve',
                    type: 'maintenance',
                    status: 'Kész',
                    date: firebase.firestore.Timestamp.fromDate(new Date('2025-06-17'))
                },
                {
                    userId: userId,
                    description: 'Új támogatási jegy: Weboldal lassú',
                    type: 'ticket',
                    status: 'Folyamatban',
                    date: firebase.firestore.Timestamp.fromDate(new Date('2025-06-16'))
                }
            ];

            for (const activity of activities) {
                await db.collection('activities').add(activity);
            }
        }

        async function loadUserData(userId) {
            try {
                console.log('📊 Adatok betöltése userId:', userId);
                
                await loadUserProfile(userId);
                await loadDashboardData(userId);
                await loadInvoices(userId);
                await loadServices(userId);
                await loadTickets(userId);
                await loadActivities(userId);
                
            } catch (error) {
                console.error('Adatbetöltési hiba:', error);
            }
        }

        async function loadUserProfile(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    const data = doc.data();
                    console.log('👤 Felhasználói adatok:', data);
                    
                    document.getElementById('companyName').value = data.companyName || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('address').value = data.address || '';
                    
                    if (data.settings) {
                        document.getElementById('emailInvoice').checked = data.settings.emailInvoice || false;
                        document.getElementById('emailTicket').checked = data.settings.emailTicket || false;
                        document.getElementById('smsNotifications').checked = data.settings.smsNotifications || false;
                    }
                }
            } catch (error) {
                console.error('Profil betöltési hiba:', error);
            }
        }

        async function loadDashboardData(userId) {
            try {
                const invoicesSnapshot = await db.collection('invoices').where('userId', '==', userId).get();
                const servicesSnapshot = await db.collection('services').where('userId', '==', userId).get();
                const ticketsSnapshot = await db.collection('tickets').where('userId', '==', userId).get();
                
                document.getElementById('totalInvoices').textContent = invoicesSnapshot.size;
                document.getElementById('activeServices').textContent = servicesSnapshot.size;
                
                const openTickets = ticketsSnapshot.docs.filter(doc => doc.data().status !== 'closed').length;
                document.getElementById('openTickets').textContent = openTickets;
                
                let monthlyCost = 0;
                let pending = 0, paid = 0;
                let urgent = 0, normal = 0;
                let inactive = 0, active = 0;
                
                servicesSnapshot.forEach(doc => {
                    const service = doc.data();
                    if (service.monthlyPrice) monthlyCost += service.monthlyPrice;
                    if (service.status === 'active') active++;
                    else inactive++;
                });

                
                invoicesSnapshot.forEach(doc => {
                    const invoice = doc.data();
                    if (invoice.status === 'paid') paid++;
                    else pending++;
                });
                
                ticketsSnapshot.forEach(doc => {
                    const ticket = doc.data();
                    if (ticket.status !== 'closed') {
                        if (ticket.priority === 'urgent') urgent++;
                        else normal++;
                    }
                });
                
                document.getElementById('monthlyCost').textContent = monthlyCost.toLocaleString('hu-HU') + ' Ft';
                document.getElementById('invoicesSummary').textContent = `${pending} függőben, ${paid} kifizetve`;
                document.getElementById('ticketsSummary').textContent = `${urgent} sürgős, ${normal} normál prioritás`;
                document.getElementById('servicesSummary').textContent = `${active} aktív, ${inactive} inaktív szolgáltatás`;
                
                console.log('📊 Dashboard adatok frissítve');
            } catch (error) {
                console.error('Dashboard adatok betöltési hiba:', error);
            }
        }

        async function loadInvoices(userId) {
            try {
                const snapshot = await db.collection('invoices').where('userId', '==', userId).orderBy('date', 'desc').get();
                const tableBody = document.getElementById('invoicesTable');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const invoice = doc.data();
                    const row = document.createElement('tr');
                    
                    const statusClass = invoice.status === 'paid' ? 'paid' : 
                                       invoice.status === 'pending' ? 'pending' : 'overdue';
                    
                    const statusText = invoice.status === 'paid' ? 'Kifizetve' : 
                                      invoice.status === 'pending' ? 'Függőben' : 'Lejárt';
                    
                    row.innerHTML = `
                        <td>#${invoice.invoiceNumber}</td>
                        <td>${new Date(invoice.date.seconds * 1000).toLocaleDateString('hu-HU')}</td>
                        <td>${invoice.amount.toLocaleString('hu-HU')} Ft</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewInvoice('${doc.id}')">Megtekint</button>
                            <button class="btn btn-sm btn-secondary" onclick="downloadInvoice('${doc.id}')">Letölt</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                console.log('💰 Számlák betöltve:', snapshot.size);
            } catch (error) {
                console.error('Számlák betöltési hiba:', error);
            }
        }

        async function loadServices(userId) {
            try {
                const snapshot = await db.collection('services').where('userId', '==', userId).get();
                const container = document.getElementById('servicesGrid');
                container.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const service = doc.data();
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    const statusClass = service.status === 'active' ? 'paid' : 'pending';
                    const statusText = service.status === 'active' ? 'Aktív' : 'Inaktív';
                    
                    const nextBilling = service.nextBilling ? 
                        new Date(service.nextBilling.seconds * 1000).toLocaleDateString('hu-HU') : 'N/A';
                    
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">
                                <i class="${service.icon || 'fas fa-server'}" style="color: #17a2b8;"></i>
                                ${service.name}
                            </div>
                        </div>
                        <div class="card-subtitle">${service.description}</div>
                        <div style="margin-top: 15px;">
                            <span class="status ${statusClass}">${statusText}</span>
                            <div style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                                Következő számlázás: ${nextBilling}
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
                
                console.log('⚙️ Szolgáltatások betöltve:', snapshot.size);
            } catch (error) {
                console.error('Szolgáltatások betöltési hiba:', error);
            }
        }

// A tickets betöltés befejezése (a félbeszakadt rész folytatása)
async function loadTickets(userId) {
    try {
        const snapshot = await db.collection('tickets').where('userId', '==', userId).orderBy('createdAt', 'desc').get();
        const tableBody = document.getElementById('ticketsTable');
        tableBody.innerHTML = '';
        
        snapshot.forEach(doc => {
            const ticket = doc.data();
            const row = document.createElement('tr');
            
            const priorityClass = ticket.priority === 'urgent' ? 'overdue' : 
                                 ticket.priority === 'high' ? 'pending' : 'paid';
            
            const priorityText = ticket.priority === 'urgent' ? 'Sürgős' : 
                                ticket.priority === 'high' ? 'Magas' : 'Normál';
            
            const statusClass = ticket.status === 'open' ? 'pending' : 
                               ticket.status === 'in_progress' ? 'pending' : 'paid';
            
            const statusText = ticket.status === 'open' ? 'Nyitott' : 
                              ticket.status === 'in_progress' ? 'Folyamatban' : 'Lezárt';
            
            // Timestamp biztonságos kezelése
            let createdDate = 'N/A';
            if (ticket.createdAt) {
                if (ticket.createdAt.seconds) {
                    createdDate = new Date(ticket.createdAt.seconds * 1000).toLocaleDateString('hu-HU');
                } else if (ticket.createdAt.toDate) {
                    createdDate = ticket.createdAt.toDate().toLocaleDateString('hu-HU');
                }
            }
            
            row.innerHTML = `
                <td>#${ticket.ticketNumber}</td>
                <td>${ticket.subject}</td>
                <td><span class="status ${priorityClass}">${priorityText}</span></td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td>${createdDate}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewTicket('${doc.id}')">Megtekint</button>
                    <button class="btn btn-sm btn-delete" onclick="deleteTicket('${doc.id}')">Törlés</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        console.log('🎫 Jegyek betöltve:', snapshot.size);
    } catch (error) {
        console.error('Jegyek betöltési hiba:', error);
        // Üres táblázat megjelenítése hiba esetén
        const tableBody = document.getElementById('ticketsTable');
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d;">Nincsenek támogatási jegyek</td></tr>';
    }
}

async function loadActivities(userId) {
    try {
        const snapshot = await db.collection('activities').where('userId', '==', userId).orderBy('date', 'desc').limit(10).get();
        const tableBody = document.getElementById('activitiesTable');
        tableBody.innerHTML = '';
        
        snapshot.forEach(doc => {
            const activity = doc.data();
            const row = document.createElement('tr');
            
            const statusClass = activity.status === 'Kész' ? 'paid' : 
                               activity.status === 'Függőben' ? 'pending' : 'pending';
            
            row.innerHTML = `
                <td>${new Date(activity.date.seconds * 1000).toLocaleDateString('hu-HU')}</td>
                <td>${activity.description}</td>
                <td><span class="status ${statusClass}">${activity.status}</span></td>
            `;
            tableBody.appendChild(row);
        });
        
        console.log('📋 Tevékenységek betöltve:', snapshot.size);
    } catch (error) {
        console.error('Tevékenységek betöltési hiba:', error);
    }
}

// Navigáció kezelése
function showSection(sectionId) {
    // Összes szekció elrejtése
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => section.classList.add('hidden'));
    
    // Aktív nav elem eltávolítása
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => item.classList.remove('active'));
    
    // Kiválasztott szekció megjelenítése
    document.getElementById(sectionId).classList.remove('hidden');
    
    // Aktív nav elem beállítása - csak ha van event
    if (typeof event !== 'undefined' && event.target) {
        event.target.closest('.nav-item').classList.add('active');
    } else {
        // Programatikus hívás esetén megkeressük a megfelelő nav elemet
        const targetNavItem = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
        if (targetNavItem) {
            targetNavItem.classList.add('active');
        }
    }
}

// Profil form kezelése
document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const profileData = {
            companyName: document.getElementById('companyName').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('users').doc(user.uid).update(profileData);
        
        // Siker üzenet megjelenítése
        showNotification('Profil sikeresen mentve!', 'success');
        
        console.log('✅ Profil mentve');
    } catch (error) {
        console.error('Profil mentési hiba:', error);
        showNotification('Hiba a profil mentése során!', 'error');
    }
});

// Beállítások form kezelése
document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const settings = {
            emailInvoice: document.getElementById('emailInvoice').checked,
            emailTicket: document.getElementById('emailTicket').checked,
            smsNotifications: document.getElementById('smsNotifications').checked
        };
        
        await db.collection('users').doc(user.uid).update({
            settings: settings,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('Beállítások sikeresen mentve!', 'success');
        
        console.log('✅ Beállítások mentve');
    } catch (error) {
        console.error('Beállítások mentési hiba:', error);
        showNotification('Hiba a beállítások mentése során!', 'error');
    }
});

// Értesítés megjelenítése
function showNotification(message, type = 'info') {
    // Létrehozzuk az értesítési elemet
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        font-weight: 500;
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    
    // CSS animáció hozzáadása
    if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(notification);
    
    // 3 másodperc után eltávolítás
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Segédfüggvények a műveletek kezeléséhez
function viewInvoice(invoiceId) {
    console.log('Számla megtekintése:', invoiceId);
    showNotification('Számla megtekintés funkció fejlesztés alatt', 'info');
}

function downloadInvoice(invoiceId) {
    console.log('Számla letöltése:', invoiceId);
    showNotification('Számla letöltés funkció fejlesztés alatt', 'info');
}

function viewTicket(ticketId) {
    console.log('Jegy megtekintése:', ticketId);
    showNotification('Jegy megtekintés funkció fejlesztés alatt', 'info');
}

async function deleteTicket(ticketId) {
    // Megerősítés kérése
    if (!confirm('Biztosan törölni szeretné ezt a támogatási jegyet?')) {
        return;
    }
    
    try {
        // Loading állapot (ha van gomb)
        const deleteBtn = event?.target;
        if (deleteBtn) {
            deleteBtn.textContent = 'Törlés...';
            deleteBtn.disabled = true;
        }
        
        // Jegy törlése Firestore-ból
        await db.collection('tickets').doc(ticketId).delete();
        console.log('✅ Jegy törölve:', ticketId);
        
        // Aktivitás naplózása
        const user = auth.currentUser;
        if (user) {
            await db.collection('activities').add({
                userId: user.uid,
                description: 'Támogatási jegy törölve',
                type: 'ticket',
                status: 'Törölve',
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Siker üzenet
        showNotification('Támogatási jegy sikeresen törölve!', 'success');
        
    } catch (error) {
        console.error('Jegy törlési hiba:', error);
        showNotification('Hiba a jegy törlése során!', 'error');
    } finally {
        // Loading állapot visszaállítása
        if (deleteBtn) {
            deleteBtn.textContent = 'Törlés';
            deleteBtn.disabled = false;
        }
    }
}
        
// Valós idejű adatfrissítés beállítása
function setupRealTimeListeners(userId) {
    // Számlák valós idejű figyelése
    db.collection('invoices').where('userId', '==', userId)
        .onSnapshot((snapshot) => {
            console.log('📊 Számlák frissítve valós időben');
            loadInvoices(userId);
            loadDashboardData(userId);
        });
    
    // Szolgáltatások valós idejű figyelése  
    db.collection('services').where('userId', '==', userId)
        .onSnapshot((snapshot) => {
            console.log('⚙️ Szolgáltatások frissítve valós időben');
            loadServices(userId);
            loadDashboardData(userId);
        });
    
    // Jegyek valós idejű figyelése
    db.collection('tickets').where('userId', '==', userId)
        .onSnapshot((snapshot) => {
            console.log('🎫 Jegyek frissítve valós időben');
            loadTickets(userId);
            loadDashboardData(userId);
        });
    
    // Tevékenységek valós idejű figyelése
    db.collection('activities').where('userId', '==', userId)
        .onSnapshot((snapshot) => {
            console.log('📋 Tevékenységek frissítve valós időben');
            loadActivities(userId);
        });
}

// Új jegy modal megnyitása
function openNewTicketModal() {
    document.getElementById('newTicketModal').style.display = 'block';
    document.body.style.overflow = 'hidden'; // Scroll letiltása
}

// Új jegy modal bezárása
function closeNewTicketModal() {
    document.getElementById('newTicketModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Scroll visszaállítása
    document.getElementById('newTicketForm').reset();
}

// Modal bezárása ESC gombbal vagy háttérre kattintással
window.onclick = function(event) {
    const modal = document.getElementById('newTicketModal');
    const deleteModal = document.getElementById('deleteConfirmModal');
    if (event.target == modal) {
        closeNewTicketModal();
    }
    if (event.target == deleteModal) {
        closeDeleteConfirmModal();
    }
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeNewTicketModal();
        closeDeleteConfirmModal();
    }
});

// Új jegy form kezelése
document.getElementById('newTicketForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) {
        showNotification('Hiba: Nincs bejelentkezett felhasználó!', 'error');
        return;
    }

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        // Loading állapot
        
        submitBtn.textContent = 'Létrehozás...';
        submitBtn.disabled = true;
        
        // Jegy szám generálása
        const now = new Date();
        const year = now.getFullYear();
        const ticketNumber = `T-${year}-${String(Math.floor(Math.random() * 999) + 1).padStart(3, '0')}`;
        
        // Új jegy adatok
        const newTicket = {
            userId: user.uid,
            ticketNumber: ticketNumber,
            subject: document.getElementById('ticketSubject').value.trim(),
            priority: document.getElementById('ticketPriority').value,
            category: document.getElementById('ticketCategory').value,
            description: document.getElementById('ticketDescription').value.trim(),
            status: 'open',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        console.log('Új jegy mentése:', newTicket);
        
        // Jegy mentése Firestore-ba
        const docRef = await db.collection('tickets').add(newTicket);
        console.log('✅ Jegy mentve, ID:', docRef.id);
        
        // Aktivitás naplózása
        await db.collection('activities').add({
            userId: user.uid,
            description: `Új támogatási jegy létrehozva: ${newTicket.subject}`,
            type: 'ticket',
            status: 'Nyitott',
            date: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('✅ Új jegy létrehozva:', ticketNumber);
        
        // Siker értesítés
        showNotification(`Jegy sikeresen létrehozva: ${ticketNumber}`, 'success');
        
        // Modal bezárása
        closeNewTicketModal();
        
        // Jegyek szekció megjelenítése
        showSection('tickets');
        
    } catch (error) {
        console.error('Jegy létrehozási hiba:', error);
        let errorMessage = 'Hiba a jegy létrehozása során';
        
        if (error.code === 'permission-denied') {
            errorMessage = 'Nincs jogosultság a jegy létrehozásához. Kérjük, jelentkezzen be újra.';
        } else if (error.message) {
            errorMessage += ': ' + error.message;
        }
        
        showNotification(errorMessage, 'error');
    } finally {
        // Loading állapot visszaállítása
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }
});

// Globális változó a törlendő jegy ID tárolásához
let ticketToDelete = null;

// Törlés modal megnyitása
function openDeleteConfirmModal(ticketId) {
    ticketToDelete = ticketId;
    document.getElementById('deleteConfirmModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// Törlés modal bezárása
function closeDeleteConfirmModal() {
    ticketToDelete = null;
    document.getElementById('deleteConfirmModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Törlés megerősítése
async function confirmDelete() {
    if (!ticketToDelete) return;
    
    try {
        // Loading állapot
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Törlés...';
        confirmBtn.disabled = true;
        
        // Jegy törlése Firestore-ból
        await db.collection('tickets').doc(ticketToDelete).delete();
        console.log('✅ Jegy törölve:', ticketToDelete);
        
        // Aktivitás naplózása
        const user = auth.currentUser;
        if (user) {
            await db.collection('activities').add({
                userId: user.uid,
                description: 'Támogatási jegy törölve',
                type: 'ticket',
                status: 'Törölve',
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Siker üzenet
        showNotification('Támogatási jegy sikeresen törölve!', 'success');
        
        // Modal bezárása
        closeDeleteConfirmModal();
        
    } catch (error) {
        console.error('Jegy törlési hiba:', error);
        showNotification('Hiba a jegy törlése során!', 'error');
        
        // Gomb visszaállítása hiba esetén
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Igen, törlöm';
        confirmBtn.disabled = false;
    }
}

// Eredeti deleteTicket függvény módosítása
function deleteTicket(ticketId) {
    openDeleteConfirmModal(ticketId);
}


// Inicializálás befejezése
document.addEventListener('DOMContentLoaded', () => {
    console.log('🚀 Dashboard inicializálva');
});
</script>
</body>
</html>
