<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitNova CRM Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="dashboardcss.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-users-cog"></i>
                BitNova CRM Dashboard
            </div>
            <div class="user-info">
                <span id="adminEmail">Admin betöltés...</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Kilépés
                </button>
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <a href="#" class="nav-item active" onclick="showSection('overview')">
                    <i class="fas fa-chart-pie"></i> Áttekintés
                </a>
                <a href="#" class="nav-item" onclick="showSection('users')">
                    <i class="fas fa-users"></i> Felhasználók
                </a>
                <a href="#" class="nav-item" onclick="showSection('all-invoices')">
                    <i class="fas fa-file-invoice-dollar"></i> Összes számla
                </a>
                <a href="#" class="nav-item" onclick="showSection('all-services')">
                    <i class="fas fa-server"></i> Szolgáltatások
                </a>
                <a href="#" class="nav-item" onclick="showSection('all-tickets')">
                    <i class="fas fa-headset"></i> Támogatási jegyek
                </a>
                <a href="#" class="nav-item" onclick="showSection('activities')">
                    <i class="fas fa-list-alt"></i> Aktivitások
                </a>
                <a href="#" class="nav-item" onclick="showSection('analytics')">
                    <i class="fas fa-chart-bar"></i> Analitika
                </a>
                <a href="#" class="nav-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> Rendszer beállítások
                </a>
            </nav>

            <main class="content">
                <!-- Áttekintés szekció -->
                <div id="overview" class="section">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">CRM Áttekintés</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-users" style="color: #667eea;"></i>
                                    Összes felhasználó
                                </div>
                            </div>
                            <div class="card-value" id="totalUsers">Betöltés...</div>
                            <div class="card-subtitle" id="usersSummary">Betöltés...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-dollar-sign" style="color: #28a745;"></i>
                                    Havi bevétel
                                </div>
                            </div>
                            <div class="card-value" id="monthlyRevenue">Betöltés...</div>
                            <div class="card-subtitle">Aktív szolgáltatásokból</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-ticket-alt" style="color: #ffc107;"></i>
                                    Aktív jegyek
                                </div>
                            </div>
                            <div class="card-value" id="activeTickets">Betöltés...</div>
                            <div class="card-subtitle" id="ticketsSummary">Betöltés...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                                    Sürgős feladatok
                                </div>
                            </div>
                            <div class="card-value" id="urgentTasks">Betöltés...</div>
                            <div class="card-subtitle" id="urgentSummary">Betöltés...</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Legutóbbi rendszer események</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Dátum</th>
                                    <th>Felhasználó</th>
                                    <th>Esemény</th>
                                    <th>Státusz</th>
                                </tr>
                            </thead>
                            <tbody id="systemEventsTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Felhasználók szekció -->
                <div id="users" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Felhasználók kezelése</h2>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="userSearch" placeholder="Keresés felhasználók között..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; width: 250px;">
                            <button class="btn btn-primary" onclick="exportUsers()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>Cégnév</th>
                                    <th>Regisztráció</th>
                                    <th>Szolgáltatások</th>
                                    <th>Nyitott jegyek</th>
                                    <th>Havi költség</th>
                                    <th>Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Részletek</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Összes számla szekció -->
                <div id="all-invoices" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Összes számla</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="invoiceStatusFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Minden státusz</option>
                                <option value="pending">Függőben</option>
                                <option value="paid">Kifizetve</option>
                                <option value="overdue">Lejárt</option>
                            </select>
                            <input type="date" id="invoiceDateFrom" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                            <input type="date" id="invoiceDateTo" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                            <button class="btn btn-secondary" onclick="filterInvoices()">
                                <i class="fas fa-filter"></i> Szűrés
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Számlaszám</th>
                                    <th>Felhasználó</th>
                                    <th>Dátum</th>
                                    <th>Összeg</th>
                                    <th>Státusz</th>
                                    <th>Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="allInvoicesTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Megtekint</button>
                                        <button class="btn btn-sm btn-secondary">Állapot</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Szolgáltatások szekció -->
                <div id="all-services" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Összes szolgáltatás</h2>
                    
                    <div class="dashboard-grid" id="allServicesGrid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-server" style="color: #17a2b8;"></i>
                                    Betöltés...
                                </div>
                            </div>
                            <div class="card-subtitle">Betöltés...</div>
                            <div style="margin-top: 15px;">
                                <span class="status paid">Betöltés...</span>
                                <div style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                                    Felhasználó: Betöltés...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Támogatási jegyek szekció -->
                <div id="all-tickets" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Összes támogatási jegy</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="ticketStatusFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Minden státusz</option>
                                <option value="open">Nyitott</option>
                                <option value="in_progress">Folyamatban</option>
                                <option value="closed">Lezárt</option>
                            </select>
                            <select id="ticketPriorityFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Minden prioritás</option>
                                <option value="normal">Normál</option>
                                <option value="high">Magas</option>
                                <option value="urgent">Sürgős</option>
                            </select>
                            <button class="btn btn-secondary" onclick="filterTickets()">
                                <i class="fas fa-filter"></i> Szűrés
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Jegy #</th>
                                    <th>Felhasználó</th>
                                    <th>Tárgy</th>
                                    <th>Prioritás</th>
                                    <th>Státusz</th>
                                    <th>Létrehozva</th>
                                    <th>Műveletek</th>
                                </tr>
                            </thead>
                            <tbody id="allTicketsTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status overdue">Betöltés...</span></td>
                                    <td><span class="status pending">Betöltés...</span></td>
                                    <td>Betöltés...</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Válasz</button>
                                        <button class="btn btn-sm btn-secondary">Állapot</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- aktivitások -->
                <div id="activities" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Rendszer aktivitások</h2>
                
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Dátum</th>
                                    <th>Felhasználó</th>
                                    <th>Esemény</th>
                                    <th>Státusz</th>
                                </tr>
                            </thead>
                            <tbody id="allActivitiesTable">
                                <tr><td colspan="4">Betöltés...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>


                <!-- Analitika szekció -->
                <div id="analytics" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Rendszer analitika</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-chart-line" style="color: #28a745;"></i>
                                    Havi növekedés
                                </div>
                            </div>
                            <div class="card-value" id="monthlyGrowth">Betöltés...</div>
                            <div class="card-subtitle">Új felhasználók</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-clock" style="color: #17a2b8;"></i>
                                    Átlag válaszidő
                                </div>
                            </div>
                            <div class="card-value" id="avgResponseTime">Betöltés...</div>
                            <div class="card-subtitle">Támogatási jegyekre</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-star" style="color: #ffc107;"></i>
                                    Ügyfél elégedettség
                                </div>
                            </div>
                            <div class="card-value" id="customerSatisfaction">Betöltés...</div>
                            <div class="card-subtitle">5-ös skálán</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-percentage" style="color: #dc3545;"></i>
                                    Lemorzsolódás
                                </div>
                            </div>
                            <div class="card-value" id="churnRate">Betöltés...</div>
                            <div class="card-subtitle">Havi arány</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Top szolgáltatások</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Szolgáltatás</th>
                                    <th>Aktív előfizetők</th>
                                    <th>Havi bevétel</th>
                                    <th>Növekedés</th>
                                </tr>
                            </thead>
                            <tbody id="topServicesTable">
                                <tr>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td>Betöltés...</td>
                                    <td><span class="status paid">Betöltés...</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Beállítások szekció -->
                <div id="settings" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Rendszer beállítások</h2>
                    
                    <div class="table-container">
                        <h3 style="margin-bottom: 15px;">Általános beállítások</h3>
                        <form id="systemSettingsForm">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Rendszer név</label>
                                <input type="text" id="systemName" value="BitNova CRM" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Admin email</label>
                                <input type="email" id="adminEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="autoBackup">
                                    Automatikus biztonsági mentés
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailNotifications">
                                    Email értesítések adminoknak
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="maintenanceMode">
                                    Karbantartási mód
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Beállítások mentése</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Felhasználó részletek modal -->
    <div id="userDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="userDetailsTitle">Felhasználó részletei</h3>
                <span class="close" onclick="closeUserDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- Dinamikusan töltődik -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserDetailsModal()">Bezárás</button>
            </div>
        </div>
    </div>

    <!-- Általános értesítési modal -->
    <div id="notificationModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="notificationTitle">Értesítés</h3>
                <button class="custom-modal-close" onclick="closeNotificationModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div id="notificationIcon"></div>
                <p id="notificationMessage">Üzenet</p>
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="closeNotificationModal()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Input modal -->
    <div id="inputModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="inputTitle">Adatok megadása</h3>
                <button class="custom-modal-close" onclick="closeInputModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <p id="inputMessage">Kérjük adja meg az adatokat:</p>
                <input type="text" id="inputField" placeholder="Írja be...">
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeInputModal()">Mégse</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmInput()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Textarea modal -->
    <div id="textareaModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="textareaTitle">Üzenet írása</h3>
                <button class="custom-modal-close" onclick="closeTextareaModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <p id="textareaMessage">Írja be az üzenetet:</p>
                <textarea id="textareaField" rows="5" placeholder="Írja be az üzenetet..."></textarea>
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeTextareaModal()">Mégse</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmTextarea()">Küldés</button>
            </div>
        </div>
    </div>
    
    <!-- Select modal -->
    <div id="selectModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="selectTitle">Válasszon opciót</h3>
                <button class="custom-modal-close" onclick="closeSelectModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <p id="selectMessage">Válassza ki a megfelelő opciót:</p>
                <select id="selectField">
                    <option value="">Válasszon...</option>
                </select>
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeSelectModal()">Mégse</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmSelect()">OK</button>
            </div>
        </div>
    </div>

    <!-- Törlés modal -->
    <div id="deleteActivityModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="deleteActivityTitle">Aktivitás törlése</h3>
                <span class="close" onclick="closeDeleteActivityModal()">&times;</span>
            </div>
            <div class="modal-body" id="deleteActivityContent">
                <p>Biztosan törölni szeretnéd ezt az aktivitást?</p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <strong>Dátum:</strong> <span id="deleteActivityDate"></span><br>
                    <strong>Felhasználó:</strong> <span id="deleteActivityUser"></span><br>
                    <strong>Esemény:</strong> <span id="deleteActivityEvent"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteActivityModal()">Mégse</button>
                <button type="button" class="btn btn-delete" id="confirmDeleteBtn">Törlés</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-firestore-compat.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAXnAo-7BF6iKjNzYr0uoJbhlpCWNaS9s4",
            authDomain: "bitnova-backend.firebaseapp.com",
            projectId: "bitnova-backend",
            storageBucket: "bitnova-backend.firebasestorage.app",
            messagingSenderId: "312941837204",
            appId: "1:312941837204:web:f6e3ff0d44cab13f30ed81",
            measurementId: "G-VBW8LX8LDE"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log('✅ Firebase inicializálva');
        } catch (error) {
            console.error('❌ Firebase inicializálási hiba:', error);
            alert('Firebase inicializálási hiba: ' + error.message);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let allUsers = [];
        let allInvoices = [];
        let allTickets = [];
        let allServices = [];

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                
                console.log('✅ Admin bejelentkezés:', user.email);
                document.getElementById('adminEmail').textContent = user.email;
                
                await loadAllData();
                setupRealTimeListeners();
                
            } else {
                console.log('❌ Nincs bejelentkezett admin');
                window.location.href = 'admin-login.html';
            }
        });

        function logout() {
            auth.signOut().then(() => {
                console.log('Sikeres kijelentkezés');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Kijelentkezési hiba:', error);
            });
        }

        async function loadAllData() {
            try {
                await loadAllUsers();

                // Majd a többi adatot
                await Promise.all([
                    loadAllInvoices(),
                    loadAllServices(),
                    loadAllTickets(),
                    loadSystemEvents(),
                    loadAnalytics(),
                    loadAllActivities()
                ]);
                
                updateOverviewStats();
                console.log('✅ Minden adat betöltve');
            } catch (error) {
                console.error('Adatbetöltési hiba:', error);
            }
        }

        async function loadAllUsers() {
            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                allUsers = [];
                
                for (const doc of snapshot.docs) {
                    const userData = { id: doc.id, ...doc.data() };
                    
                    // Számoljuk ki a felhasználó statisztikáit
                    const userStats = await getUserStats(doc.id);
                    userData.stats = userStats;
                    
                    allUsers.push(userData);
                }
                
                displayUsers(allUsers);
                console.log('👥 Felhasználók betöltve:', allUsers.length);
            } catch (error) {
                console.error('Felhasználók betöltési hiba:', error);
            }
        }

        async function getUserStats(userId) {
            try {
                const [servicesSnap, ticketsSnap, invoicesSnap] = await Promise.all([
                    db.collection('services').where('userId', '==', userId).get(),
                    db.collection('tickets').where('userId', '==', userId).where('status', '!=', 'closed').get(),
                    db.collection('invoices').where('userId', '==', userId).get()
                ]);

                let monthlyCost = 0;
                servicesSnap.forEach(doc => {
                    const service = doc.data();
                    if (service.status === 'active' && service.monthlyPrice) {
                        monthlyCost += service.monthlyPrice;
                    }
                });

                return {
                    services: servicesSnap.size,
                    openTickets: ticketsSnap.size,
                    monthlyCost: monthlyCost,
                    totalInvoices: invoicesSnap.size
                };
            } catch (error) {
                console.error('Felhasználó statisztikák hiba:', error);
                return { services: 0, openTickets: 0, monthlyCost: 0, totalInvoices: 0 };
            }
        }

        function displayUsers(users) {
            const tableBody = document.getElementById('usersTable');
            tableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                const createdDate = user.createdAt ? 
                    new Date(user.createdAt.seconds * 1000).toLocaleDateString('hu-HU') : 'N/A';
                
                row.innerHTML = `
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.companyName || 'Nincs megadva'}</td>
                    <td>${createdDate}</td>
                    <td>${user.stats?.services || 0}</td>
                    <td>${user.stats?.openTickets || 0}</td>
                    <td>${(user.stats?.monthlyCost || 0).toLocaleString('hu-HU')} Ft</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showUserDetails('${user.id}')">Részletek</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function loadAllInvoices() {
            try {
                const snapshot = await db.collection('invoices').orderBy('date', 'desc').get();
                allInvoices = [];
                
                for (const doc of snapshot.docs) {
                    const invoice = { id: doc.id, ...doc.data() };
                    
                    // Keressük meg a felhasználó adatait
                    const user = allUsers.find(u => u.id === invoice.userId);
                    invoice.userEmail = user?.email || 'Ismeretlen';
                    
                    allInvoices.push(invoice);
                }
                
                displayInvoices(allInvoices);
                console.log('💰 Számlák betöltve:', allInvoices.length);
            } catch (error) {
                console.error('Számlák betöltési hiba:', error);
            }
        }

        function displayInvoices(invoices) {
            const tableBody = document.getElementById('allInvoicesTable');
            tableBody.innerHTML = '';
            
            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                
                const statusClass = invoice.status === 'paid' ? 'paid' : 
                                   invoice.status === 'pending' ? 'pending' : 'overdue';
                
                const statusText = invoice.status === 'paid' ? 'Kifizetve' : 
                                  invoice.status === 'pending' ? 'Függőben' : 'Lejárt';
                
                row.innerHTML = `
                    <td>#${invoice.invoiceNumber}</td>
                    <td>${invoice.userEmail}</td>
                    <td>${new Date(invoice.date.seconds * 1000).toLocaleDateString('hu-HU')}</td>
                    <td>${invoice.amount.toLocaleString('hu-HU')} Ft</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewInvoice('${invoice.id}')">Megtekint</button>
                        <button class="btn btn-sm btn-secondary" onclick="changeInvoiceStatus('${invoice.id}')">Állapot</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function loadAllServices() {
            try {
                const snapshot = await db.collection('services').get();
                allServices = [];
                
                for (const doc of snapshot.docs) {
                    const service = { id: doc.id, ...doc.data() };
                    
                    const user = allUsers.find(u => u.id === service.userId);
                    service.userEmail = user?.email || 'Ismeretlen';
                    
                    allServices.push(service);
                }
                
                displayServices(allServices);
                console.log('⚙️ Szolgáltatások betöltve:', allServices.length);
            } catch (error) {
                console.error('Szolgáltatások betöltési hiba:', error);
            }
        }

        // CRM Dashboard - Hiányzó JavaScript funkciók
        // Ezt a kódot add hozzá a meglévő script tag-hez vagy külön fájlként
        
        // Szolgáltatások megjelenítése folytatása (a displayServices függvény befejezése)
        function displayServices(services) {
            const container = document.getElementById('allServicesGrid');
            container.innerHTML = '';
            
            services.forEach(service => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const statusClass = service.status === 'active' ? 'paid' : 
                                   service.status === 'suspended' ? 'overdue' : 'pending';
                const statusText = service.status === 'active' ? 'Aktív' : 
                                  service.status === 'suspended' ? 'Felfüggesztve' : 'Inaktív';
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-server" style="color: #17a2b8;"></i>
                            ${service.name || 'Szolgáltatás'}
                        </div>
                    </div>
                    <div class="card-subtitle">${service.description || 'Nincs leírás'}</div>
                    <div style="margin-top: 15px;">
                        <span class="status ${statusClass}">${statusText}</span>
                        <div style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                            Felhasználó: ${service.userEmail}
                        </div>
                        <div style="margin-top: 5px; color: #6c757d; font-size: 14px;">
                            Havi díj: ${(service.monthlyPrice || 0).toLocaleString('hu-HU')} Ft
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // Támogatási jegyek betöltése
        async function loadAllTickets() {
            try {
                const snapshot = await db.collection('tickets').orderBy('createdAt', 'desc').get();
                allTickets = [];
                
                for (const doc of snapshot.docs) {
                    const ticket = { id: doc.id, ...doc.data() };
                    
                    let user = allUsers.find(u => u.id === ticket.userId);
                    if (!user) {
                        // Ha nem találjuk a felhasználót a cache-ben, kérjük le közvetlenül
                        try {
                            const userDoc = await db.collection('users').doc(ticket.userId).get();
                            if (userDoc.exists) {
                                user = { id: userDoc.id, ...userDoc.data() };
                            }
                        } catch (error) {
                            console.error('Felhasználó lekérési hiba:', error);
                        }
                    }
                    ticket.userEmail = user?.email || 'Ismeretlen';
                    
                    allTickets.push(ticket);
                }
                
                displayTickets(allTickets);
                console.log('🎫 Jegyek betöltve:', allTickets.length);
            } catch (error) {
                console.error('Jegyek betöltési hiba:', error);
            }
        }
        
        // Támogatási jegyek megjelenítése
        function displayTickets(tickets) {
            const tableBody = document.getElementById('allTicketsTable');
            tableBody.innerHTML = '';
            
            tickets.forEach(ticket => {
                const row = document.createElement('tr');
                
                const priorityClass = ticket.priority === 'urgent' ? 'overdue' : 
                                     ticket.priority === 'high' ? 'pending' : 'paid';
                const priorityText = ticket.priority === 'urgent' ? 'Sürgős' : 
                                    ticket.priority === 'high' ? 'Magas' : 'Normál';
                
                const statusClass = ticket.status === 'open' ? 'overdue' : 
                                   ticket.status === 'in_progress' ? 'pending' : 'paid';
                const statusText = ticket.status === 'open' ? 'Nyitott' : 
                                  ticket.status === 'in_progress' ? 'Folyamatban' : 'Lezárt';
                
                const createdDate = ticket.createdAt ? 
                    new Date(ticket.createdAt.seconds * 1000).toLocaleDateString('hu-HU') : 'N/A';
                
                row.innerHTML = `
                    <td>#${ticket.ticketNumber || ticket.id.substring(0, 8)}</td>
                    <td>${ticket.userEmail}</td>
                    <td>${ticket.subject || 'Nincs tárgy'}</td>
                    <td><span class="status ${priorityClass}">${priorityText}</span></td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="replyToTicket('${ticket.id}')">Válasz</button>
                        <button class="btn btn-sm btn-secondary" onclick="changeTicketStatus('${ticket.id}')">Állapot</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Rendszer események betöltése 
        async function loadSystemEvents() {
            try {
                console.log('🔄 Rendszer események betöltése kezdődik...');
                
                // Mivel 'date' mező string, nem tudjuk rendezni időrendben
                // Ezért egyszerű lekérdezést használunk
                const snapshot = await db.collection('activities')
                    .limit(10) 
                    .get();
                
                console.log('📊 Lekért dokumentumok száma:', snapshot.size);
                
                // Felhasználók lekérése
                const usersSnapshot = await db.collection('users').get();
                const usersMap = {};
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    usersMap[doc.id] = userData.email || 'Email nem található';
                });
                
                const events = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('📄 Dokumentum adatok:', data);
                    
                    const event = {
                        id: doc.id,
                        timestamp: {
                            seconds: data.date.seconds || data.date._seconds || (new Date(data.date).getTime() / 1000)
                        },
                        userEmail: data.userId ? (usersMap[data.userId] || 'Felhasználó nem található') : 'Rendszer',
                        event: data.description || data.type || 'Ismeretlen esemény',
                        status: data.status === 'Nyitott' ? 'warning' : 
                               data.status === 'Lezárt' ? 'success' : 'pending'
                    };
                    
                    events.push(event);
                });
                
                // Rendezés dátum szerint (legújabb először)
                events.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                
                // Csak az első 10-et tartjuk meg
                const limitedEvents = events.slice(0, 10);
                
                displaySystemEvents(limitedEvents);
                console.log('✅ Rendszer események betöltve:', limitedEvents.length);
                
            } catch (error) {
                console.error('❌ Rendszer események betöltési hiba:', error);
                
                // Fallback adatok
                displaySystemEvents([
                    {
                        timestamp: { seconds: Date.now() / 1000 },
                        userEmail: 'system@bitnova.hu',
                        event: 'Rendszer indítás (fallback)',
                        status: 'success'
                    }
                ]);
            }
        }
        
        // Rendszer események megjelenítése
        function displaySystemEvents(events) {
            const tableBody = document.getElementById('systemEventsTable');
            
            if (!tableBody) {
                console.error('❌ systemEventsTable elem nem található!');
                return;
            }
            
            tableBody.innerHTML = '';
            
            events.forEach(event => {
                const row = document.createElement('tr');
                
                // Status class meghatározása
                const statusClass = event.status === 'success' ? 'paid' : 
                                   event.status === 'warning' ? 'pending' : 'overdue';
                const statusText = event.status === 'success' ? 'Sikeres' : 
                                  event.status === 'warning' ? 'Figyelmeztetés' : 
                                  event.status === 'pending' ? 'Folyamatban' : 'Hiba';
                
                // Dátum formázása
                const eventDate = event.timestamp ? 
                    new Date(event.timestamp.seconds * 1000).toLocaleString('hu-HU') : 'N/A';
                
                row.innerHTML = `
                    <td>${eventDate}</td>
                    <td>${event.userEmail || 'Rendszer'}</td>
                    <td>${event.event || 'Ismeretlen esemény'}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            console.log('📋 Táblázat frissítve', events.length, 'eseménnyel');
        }

        // osszes aktivitas lekerese
        async function loadAllActivities() {
            try {
                console.log('🔄 Összes aktivitás betöltése (optimalizált)...');
                
                // Párhuzamosan lekérjük az aktivitásokat és felhasználókat
                const [activitiesSnapshot, usersSnapshot] = await Promise.all([
                    db.collection('activities').get(),
                    db.collection('users').get()
                ]);
                
                console.log('📊 Lekért aktivitások:', activitiesSnapshot.size);
                console.log('👥 Lekért felhasználók:', usersSnapshot.size);
                
                // Felhasználók indexelése ID alapján
                const usersMap = {};
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    usersMap[doc.id] = userData.email || 'Email nem található';
                });
                
                const events = [];
                activitiesSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Felhasználó email lekérése a map-ből
                    const userEmail = data.userId ? 
                        (usersMap[data.userId] || 'Felhasználó nem található') : 
                        'Rendszer';
                    
                    // Átalakítjuk a formátumot
                    const event = {
                        id: doc.id,
                        timestamp: {
                            seconds: data.date.seconds || data.date._seconds || (new Date(data.date).getTime() / 1000)
                        },
                        userEmail: userEmail,
                        event: data.description || data.type || 'Ismeretlen esemény',
                        status: mapStatus(data.status),
                        originalData: data
                    };
                    
                    events.push(event);
                });
                
                // Rendezés dátum szerint (legújabb először)
                events.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                
                console.log('✅ Aktivitások rendezve:', events.length);
                displayAllActivities(events);
                
            } catch (error) {
                console.error('❌ Aktivitások betöltési hiba:', error);
                
                const tableBody = document.getElementById('allActivitiesTable');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="color: red; text-align: center;">
                                Hiba az aktivitások betöltése során: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        // Status átalakító függvény (változatlan)
        function mapStatus(originalStatus) {
            if (!originalStatus) return 'warning';
            
            const status = originalStatus.toLowerCase();
            
            if (status.includes('nyitott') || status.includes('pending')) {
                return 'warning';
            } else if (status.includes('lezárt') || status.includes('sikeres') || status.includes('complete')) {
                return 'success';
            } else {
                return 'overdue';
            }
        }
        
        // Összes aktivitás megjelenítése - javított verzió
        function displayAllActivities(events) {
            const tableBody = document.getElementById('allActivitiesTable');
            
            if (!tableBody) {
                console.error('❌ allActivitiesTable elem nem található!');
                return;
            }
            
            tableBody.innerHTML = '';
        
            if (events.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nincs aktivitás az adatbázisban</td></tr>';
                return;
            }
        
            events.forEach((event, index) => {
                const row = document.createElement('tr');
        
                // Dátum formázása
                const date = event.timestamp ?
                    new Date(event.timestamp.seconds * 1000).toLocaleString('hu-HU', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'N/A';
        
                // Status osztály és szöveg
                const statusClass = event.status === 'success' ? 'paid' :
                                   event.status === 'warning' ? 'pending' : 'overdue';
        
                const statusText = event.status === 'success' ? 'Sikeres' :
                                  event.status === 'warning' ? 'Folyamatban' : 'Probléma';
        
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${event.userEmail || 'Rendszer'}</td>
                    <td>${event.event || 'Ismeretlen esemény'}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td><button class="btn btn-sm btn-delete" onclick="openDeleteActivityModal('${event.id}', '${date}', '${event.userEmail}', '${event.event}')">Törlés</button></td>
                `;
        
                tableBody.appendChild(row);
                
                // Debug info konzolba (első 3 elemre)
                if (index < 3) {
                    console.log(`📄 Aktivitás ${index + 1}:`, {
                        date: date,
                        user: event.userEmail,
                        event: event.event,
                        status: event.status,
                        original: event.originalData
                    });
                }
            });
            
            console.log(`📋 Táblázat feltöltve ${events.length} aktivitással`);
        }

        // Aktivitás törlése
        // Modal megnyitása
        function openDeleteActivityModal(activityId, date, userEmail, event) {
            document.getElementById('deleteActivityDate').textContent = date;
            document.getElementById('deleteActivityUser').textContent = userEmail;
            document.getElementById('deleteActivityEvent').textContent = event;
            
            document.getElementById('confirmDeleteBtn').onclick = () => confirmDeleteActivity(activityId);
            document.getElementById('deleteActivityModal').style.display = 'block';
        }
        
        // Modal bezárása
        function closeDeleteActivityModal() {
            document.getElementById('deleteActivityModal').style.display = 'none';
        }
        
        // Törlés megerősítése
        async function confirmDeleteActivity(activityId) {
            try {
                console.log('🗑️ Aktivitás törlése:', activityId);
                
                await db.collection('activities').doc(activityId).delete();
                
                console.log('✅ Aktivitás törölve');
                closeDeleteActivityModal();
                loadAllActivities(); // Táblázat újratöltése
                
            } catch (error) {
                console.error('❌ Törlési hiba:', error);
                alert('Hiba történt a törlés során: ' + error.message);
            }
        }
       
        // Analitika betöltése
        async function loadAnalytics() {
            try {
                // Havi növekedés számítása
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                
                const newUsersCount = allUsers.filter(user => 
                    user.createdAt && new Date(user.createdAt.seconds * 1000) > lastMonth
                ).length;
                
                // Átlag válaszidő (példa számítás)
                const avgResponseTime = calculateAverageResponseTime();
                
                // Ügyfél elégedettség (példa érték)
                const customerSatisfaction = 4.2;
                
                // Lemorzsolódási arány (példa számítás)
                const churnRate = calculateChurnRate();
                
                updateAnalytics({
                    monthlyGrowth: newUsersCount,
                    avgResponseTime: avgResponseTime,
                    customerSatisfaction: customerSatisfaction,
                    churnRate: churnRate
                });
                
                loadTopServices();
                
            } catch (error) {
                console.error('Analitika betöltési hiba:', error);
            }
        }
        
        // Analitika megjelenítése
        function updateAnalytics(data) {
            document.getElementById('monthlyGrowth').textContent = `+${data.monthlyGrowth}`;
            document.getElementById('avgResponseTime').textContent = `${data.avgResponseTime}h`;
            document.getElementById('customerSatisfaction').textContent = data.customerSatisfaction.toFixed(1);
            document.getElementById('churnRate').textContent = `${data.churnRate}%`;
        }
        
        // Átlag válaszidő számítása
        function calculateAverageResponseTime() {
            // Példa számítás - valódi implementációban a tickets válaszideit számolnánk
            return Math.floor(Math.random() * 24) + 1;
        }
        
        // Lemorzsolódási arány számítása
        function calculateChurnRate() {
            // Példa számítás
            const totalUsers = allUsers.length;
            const inactiveUsers = allUsers.filter(user => {
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                return user.lastLogin && new Date(user.lastLogin.seconds * 1000) < lastMonth;
            }).length;
            
            return totalUsers > 0 ? ((inactiveUsers / totalUsers) * 100).toFixed(1) : 0;
        }
        
        // Top szolgáltatások betöltése
        function loadTopServices() {
            const serviceStats = {};
            
            allServices.forEach(service => {
                const serviceName = service.name || 'Ismeretlen szolgáltatás';
                if (!serviceStats[serviceName]) {
                    serviceStats[serviceName] = {
                        name: serviceName,
                        activeSubscribers: 0,
                        monthlyRevenue: 0
                    };
                }
                
                if (service.status === 'active') {
                    serviceStats[serviceName].activeSubscribers++;
                    serviceStats[serviceName].monthlyRevenue += service.monthlyPrice || 0;
                }
            });
            
            const topServices = Object.values(serviceStats)
                .sort((a, b) => b.monthlyRevenue - a.monthlyRevenue)
                .slice(0, 5);
            
            displayTopServices(topServices);
        }
        
        // Top szolgáltatások megjelenítése
        function displayTopServices(services) {
            const tableBody = document.getElementById('topServicesTable');
            tableBody.innerHTML = '';
            
            services.forEach(service => {
                const row = document.createElement('tr');
                const growth = Math.floor(Math.random() * 20) + 5; // Példa növekedés
                
                row.innerHTML = `
                    <td>${service.name}</td>
                    <td>${service.activeSubscribers}</td>
                    <td>${service.monthlyRevenue.toLocaleString('hu-HU')} Ft</td>
                    <td><span class="status paid">+${growth}%</span></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Áttekintés statisztikák frissítése
        function updateOverviewStats() {
            // Összes felhasználó
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('usersSummary').textContent = `${allUsers.filter(u => u.stats?.services > 0).length} aktív ügyfél`;
            
            // Havi bevétel
            const monthlyRevenue = allServices
                .filter(s => s.status === 'active')
                .reduce((sum, s) => sum + (s.monthlyPrice || 0), 0);
            document.getElementById('monthlyRevenue').textContent = `${monthlyRevenue.toLocaleString('hu-HU')} Ft`;
            
            // Aktív jegyek
            const activeTickets = allTickets.filter(t => t.status !== 'closed').length;
            document.getElementById('activeTickets').textContent = activeTickets;
            document.getElementById('ticketsSummary').textContent = `${allTickets.filter(t => t.priority === 'urgent').length} sürgős`;
            
            // Sürgős feladatok
            const urgentTasks = allTickets.filter(t => t.priority === 'urgent' && t.status !== 'closed').length;
            document.getElementById('urgentTasks').textContent = urgentTasks;
            document.getElementById('urgentSummary').textContent = urgentTasks > 0 ? 'Azonnali figyelmet igényel' : 'Nincs sürgős feladat';
        }
        
        // Navigáció kezelése
        function showSection(sectionId) {
            // Összes szekció elrejtése
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Aktív szekció megjelenítése
            document.getElementById(sectionId).classList.remove('hidden');
            
            // Navigációs elemek frissítése
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Felhasználó részletek megjelenítése
        async function showUserDetails(userId) {
            try {
                const user = allUsers.find(u => u.id === userId);
                if (!user) return;
                
                const userServices = allServices.filter(s => s.userId === userId);
                const userTickets = allTickets.filter(t => t.userId === userId);
                const userInvoices = allInvoices.filter(i => i.userId === userId);
                
                const modalContent = document.getElementById('userDetailsContent');
                modalContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>Alapadatok</h4>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>Cégnév:</strong> ${user.companyName || 'Nincs megadva'}</p>
                        <p><strong>Regisztráció:</strong> ${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString('hu-HU') : 'N/A'}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>Statisztikák</h4>
                        <p><strong>Szolgáltatások:</strong> ${userServices.length}</p>
                        <p><strong>Nyitott jegyek:</strong> ${userTickets.filter(t => t.status !== 'closed').length}</p>
                        <p><strong>Összes számla:</strong> ${userInvoices.length}</p>
                        <p><strong>Havi költség:</strong> ${user.stats?.monthlyCost?.toLocaleString('hu-HU') || 0} Ft</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>Szolgáltatások</h4>
                        ${userServices.length > 0 ? 
                            userServices.map(s => `<p>• ${s.name} (${s.status})</p>`).join('') : 
                            '<p>Nincs szolgáltatás</p>'
                        }
                    </div>
                `;
                
                document.getElementById('userDetailsModal').style.display = 'block';
                
            } catch (error) {
                console.error('Felhasználó részletek hiba:', error);
            }
        }
        
        // Modal bezárása
        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').style.display = 'none';
        }
        
        // Keresés a felhasználók között
        document.getElementById('userSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.email?.toLowerCase().includes(searchTerm) ||
                user.companyName?.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        });
        
        // Számlák szűrése
        function filterInvoices() {
            const statusFilter = document.getElementById('invoiceStatusFilter').value;
            const dateFrom = document.getElementById('invoiceDateFrom').value;
            const dateTo = document.getElementById('invoiceDateTo').value;
            
            let filteredInvoices = allInvoices;
            
            if (statusFilter) {
                filteredInvoices = filteredInvoices.filter(invoice => invoice.status === statusFilter);
            }
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filteredInvoices = filteredInvoices.filter(invoice => 
                    new Date(invoice.date.seconds * 1000) >= fromDate
                );
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                filteredInvoices = filteredInvoices.filter(invoice => 
                    new Date(invoice.date.seconds * 1000) <= toDate
                );
            }
            
            displayInvoices(filteredInvoices);
        }
        
        // Jegyek szűrése
        function filterTickets() {
            const statusFilter = document.getElementById('ticketStatusFilter').value;
            const priorityFilter = document.getElementById('ticketPriorityFilter').value;
            
            let filteredTickets = allTickets;
            
            if (statusFilter) {
                filteredTickets = filteredTickets.filter(ticket => ticket.status === statusFilter);
            }
            
            if (priorityFilter) {
                filteredTickets = filteredTickets.filter(ticket => ticket.priority === priorityFilter);
            }
            
            displayTickets(filteredTickets);
        }
        
        // Felhasználók exportálása
        function exportUsers() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Email,Cégnév,Regisztráció,Szolgáltatások,Nyitott jegyek,Havi költség\n"
                + allUsers.map(user => [
                    user.email || '',
                    user.companyName || '',
                    user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString('hu-HU') : '',
                    user.stats?.services || 0,
                    user.stats?.openTickets || 0,
                    user.stats?.monthlyCost || 0
                ].join(',')).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "felhasznalok.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Számlák műveletek
        function viewInvoice(invoiceId) {
            showNotification(`Számla megtekintése: ${invoiceId}`, 'success');
            // Itt implementálhatod a számla részletes megjelenítését
        }
        
        async function changeInvoiceStatus(invoiceId) {
            const newStatus = await showSelectModal('Válassza ki az új státuszt:', [
                {value: 'paid', text: 'Kifizetve'},
                {value: 'pending', text: 'Függőben'},
                {value: 'overdue', text: 'Lejárt'}
            ], 'Számla státusz módosítása');
            if (newStatus && ['paid', 'pending', 'overdue'].includes(newStatus)) {
                db.collection('invoices').doc(invoiceId).update({
                    status: newStatus
                }).then(() => {
                    console.log('Számla státusz frissítve');
                    loadAllInvoices();
                }).catch(error => {
                    console.error('Státusz frissítési hiba:', error);
                });
            }
        }
        
        // Jegy műveletek
        async function replyToTicket(ticketId) {
        const reply = await showTextareaModal('Írjon választ a jegyre:', 'Válasz szövege...', 'Válasz küldése');
        if (reply) {
            try {
                // Reply mező frissítése a Firestore-ban
                await db.collection('tickets').doc(ticketId).update({
                    reply: reply,
                    status: 'in_progress', 
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
    
                showNotification(`Válasz küldve: ${ticketId}`, 'success');
            } catch (error) {
                showNotification('Hiba történt a válasz küldésekor', 'error');
                console.error(error);
            }
        }
    }
        
        async function changeTicketStatus(ticketId) {
            const newStatus = await showSelectModal('Válassza ki az új státuszt:', [
                {value: 'open', text: 'Nyitott'},
                {value: 'in_progress', text: 'Folyamatban'},
                {value: 'closed', text: 'Lezárt'}
            ], 'Jegy státusz módosítása');
            if (newStatus && ['open', 'in_progress', 'closed'].includes(newStatus)) {
                db.collection('tickets').doc(ticketId).update({
                    status: newStatus
                }).then(() => {
                    console.log('Jegy státusz frissítve');
                    loadAllTickets();
                }).catch(error => {
                    console.error('Státusz frissítési hiba:', error);
                });
            }
        }
        
        // Beállítások kezelése
        document.getElementById('systemSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const settings = {
                systemName: document.getElementById('systemName').value,
                adminEmail: document.getElementById('adminEmail').value,
                autoBackup: document.getElementById('autoBackup').checked,
                emailNotifications: document.getElementById('emailNotifications').checked,
                maintenanceMode: document.getElementById('maintenanceMode').checked
            };
            
            // Beállítások mentése Firebase-be
            db.collection('system_settings').doc('general').set(settings)
                .then(() => {
                    showNotification(`Beállítások mentve!`, 'success');
                })
                .catch(error => {
                    console.error('Beállítások mentési hiba:', error);
                    showNotification(`Hiba a beállítások mentésekor!`, 'success');
                });
        });
        
        // Valós idejű frissítések beállítása
        function setupRealTimeListeners() {
            // Felhasználók változásainak figyelése
            db.collection('users').onSnapshot(() => {
                loadAllUsers();
            });
            
            // Jegyek változásainak figyelése
            db.collection('tickets').onSnapshot(() => {
                loadAllTickets();
                updateOverviewStats();
            });
            
            // Szolgáltatások változásainak figyelése
            db.collection('services').onSnapshot(() => {
                loadAllServices();
                updateOverviewStats();
            });

            db.collection('activities').onSnapshot(() => {
                loadAllActivities();
            });
       
            console.log('🔄 Valós idejű figyelés beállítva');
        }
        
        // Modal-ok általános kezelése
        window.onclick = function(event) {
            const modal = document.getElementById('userDetailsModal');
            if (event.target === modal) {
                modal.style.display = "none";
            }
        }

        // Modal kezelő változók
        let currentModalResolve = null;
        let currentModalReject = null;
        
        // Értesítési modal megjelenítése
        function showNotification(message, type = 'info', title = 'Értesítés') {
            const modal = document.getElementById('notificationModal');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const iconEl = document.getElementById('notificationIcon');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Ikon beállítása típus szerint
            let iconClass = '';
            switch(type) {
                case 'success':
                    iconClass = 'fas fa-check-circle success-icon';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-circle error-icon';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle warning-icon';
                    break;
                default:
                    iconClass = 'fas fa-info-circle' + (type === 'info' ? ' text-primary' : '');
            }
            
            iconEl.innerHTML = `<i class="${iconClass}"></i>`;
            modal.style.display = 'block';
        }
        
        function closeNotificationModal() {
            document.getElementById('notificationModal').style.display = 'none';
        }
        
        // Input modal megjelenítése
        function showInputModal(message, placeholder = '', title = 'Adatok megadása') {
            return new Promise((resolve, reject) => {
                currentModalResolve = resolve;
                currentModalReject = reject;
                
                const modal = document.getElementById('inputModal');
                const titleEl = document.getElementById('inputTitle');
                const messageEl = document.getElementById('inputMessage');
                const inputEl = document.getElementById('inputField');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                inputEl.placeholder = placeholder;
                inputEl.value = '';
                
                modal.style.display = 'block';
                inputEl.focus();
            });
        }
        
        function closeInputModal() {
            document.getElementById('inputModal').style.display = 'none';
            if (currentModalReject) {
                currentModalReject();
                currentModalReject = null;
                currentModalResolve = null;
            }
        }
        
        function confirmInput() {
            const value = document.getElementById('inputField').value;
            document.getElementById('inputModal').style.display = 'none';
            if (currentModalResolve) {
                currentModalResolve(value);
                currentModalResolve = null;
                currentModalReject = null;
            }
        }
        
        // Textarea modal megjelenítése
        function showTextareaModal(message, placeholder = '', title = 'Üzenet írása') {
            return new Promise((resolve, reject) => {
                currentModalResolve = resolve;
                currentModalReject = reject;
                
                const modal = document.getElementById('textareaModal');
                const titleEl = document.getElementById('textareaTitle');
                const messageEl = document.getElementById('textareaMessage');
                const textareaEl = document.getElementById('textareaField');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                textareaEl.placeholder = placeholder;
                textareaEl.value = '';
                
                modal.style.display = 'block';
                textareaEl.focus();
            });
        }
        
        function closeTextareaModal() {
            document.getElementById('textareaModal').style.display = 'none';
            if (currentModalReject) {
                currentModalReject();
                currentModalReject = null;
                currentModalResolve = null;
            }
        }
        
        function confirmTextarea() {
            const value = document.getElementById('textareaField').value;
            document.getElementById('textareaModal').style.display = 'none';
            if (currentModalResolve) {
                currentModalResolve(value);
                currentModalResolve = null;
                currentModalReject = null;
            }
        }
        
        // Select modal megjelenítése
        function showSelectModal(message, options, title = 'Válasszon opciót') {
            return new Promise((resolve, reject) => {
                currentModalResolve = resolve;
                currentModalReject = reject;
                
                const modal = document.getElementById('selectModal');
                const titleEl = document.getElementById('selectTitle');
                const messageEl = document.getElementById('selectMessage');
                const selectEl = document.getElementById('selectField');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                // Opciók feltöltése
                selectEl.innerHTML = '<option value="">Válasszon...</option>';
                options.forEach(option => {
                    const optionEl = document.createElement('option');
                    optionEl.value = option.value;
                    optionEl.textContent = option.text;
                    selectEl.appendChild(optionEl);
                });
                
                modal.style.display = 'block';
                selectEl.focus();
            });
        }
        
        function closeSelectModal() {
            document.getElementById('selectModal').style.display = 'none';
            if (currentModalReject) {
                currentModalReject();
                currentModalReject = null;
                currentModalResolve = null;
            }
        }
        
        function confirmSelect() {
            const value = document.getElementById('selectField').value;
            document.getElementById('selectModal').style.display = 'none';
            if (currentModalResolve) {
                currentModalResolve(value);
                currentModalResolve = null;
                currentModalReject = null;
            }
        }
        
        // Enter lenyomás kezelése
        document.getElementById('inputField').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') confirmInput();
        });
        
        document.getElementById('textareaField').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) confirmTextarea();
        });

        
    </script>
</body>
</html>
