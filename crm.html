<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitNova CRM</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="dashboardcss.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-server"></i>
                BitNova CRM
            </div>
            <div class="user-info">
                <span id="userEmail">Bet√∂lt√©s...</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Kil√©p√©s
                </button>
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <a href="#" class="nav-item active" onclick="showSection('dashboard')">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a href="#" class="nav-item" onclick="showSection('invoices')">
                    <i class="fas fa-file-invoice"></i> Sz√°ml√°k
                </a>
                <a href="#" class="nav-item" onclick="showSection('services')">
                    <i class="fas fa-cogs"></i> Szolg√°ltat√°sok
                </a>
                <a href="#" class="nav-item" onclick="showSection('tickets')">
                    <i class="fas fa-ticket-alt"></i> T√°mogat√°si jegyek
                </a>
                <a href="#" class="nav-item" onclick="showSection('profile')">
                    <i class="fas fa-user"></i> Profil
                </a>
                <a href="#" class="nav-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> Be√°ll√≠t√°sok
                </a>
            </nav>

            <main class="content">
                <div id="dashboard" class="section">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">√Åttekint√©s</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-file-invoice" style="color: #667eea;"></i>
                                    Sz√°ml√°k √∂sszesen
                                </div>
                            </div>
                            <div class="card-value" id="totalInvoices">Bet√∂lt√©s...</div>
                            <div class="card-subtitle" id="invoicesSummary">Bet√∂lt√©s...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-money-bill-wave" style="color: #28a745;"></i>
                                    Havi k√∂lts√©g
                                </div>
                            </div>
                            <div class="card-value" id="monthlyCost">Bet√∂lt√©s...</div>
                            <div class="card-subtitle">Aktu√°lis havi szolg√°ltat√°sok</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-server" style="color: #17a2b8;"></i>
                                    Szolg√°ltat√°sok
                                </div>
                            </div>
                            <div class="card-value" id="activeServices">Bet√∂lt√©s...</div>
                            <div class="card-subtitle" id="servicesSummary">Bet√∂lt√©s...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-ticket-alt" style="color: #ffc107;"></i>
                                    Nyitott jegyek
                                </div>
                            </div>
                            <div class="card-value" id="openTickets">Bet√∂lt√©s...</div>
                            <div class="card-subtitle" id="ticketsSummary">Bet√∂lt√©s...</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Legut√≥bbi tev√©kenys√©gek</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>D√°tum</th>
                                    <th>Tev√©kenys√©g</th>
                                    <th>St√°tusz</th>
                                </tr>
                            </thead>
                            <tbody id="activitiesTable">
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td><span class="status pending">Bet√∂lt√©s...</span></td>
                                </tr>
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td><span class="status paid">Bet√∂lt√©s...</span></td>
                                </tr>
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td><span class="status pending">Bet√∂lt√©s...</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="invoices" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Sz√°ml√°k</h2>
                        <button class="btn btn-primary">
                            <i class="fas fa-plus"></i> √öj sz√°mla
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sz√°mlasz√°m</th>
                                    <th>D√°tum</th>
                                    <th>√ñsszeg</th>
                                    <th>St√°tusz</th>
                                    <th>M≈±veletek</th>
                                </tr>
                            </thead>
                            <tbody id="invoicesTable">
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td><span class="status pending">Bet√∂lt√©s...</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Megtekint</button>
                                        <button class="btn btn-sm btn-secondary">Let√∂lt</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="services" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Szolg√°ltat√°sok</h2>
                    
                    <div class="dashboard-grid" id="servicesGrid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-server" style="color: #17a2b8;"></i>
                                    Bet√∂lt√©s...
                                </div>
                            </div>
                            <div class="card-subtitle">Bet√∂lt√©s...</div>
                            <div style="margin-top: 15px;">
                                <span class="status paid">Bet√∂lt√©s...</span>
                                <div style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                                    Bet√∂lt√©s...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="tickets" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">T√°mogat√°si jegyek</h2>
                        <button class="btn btn-primary" onclick="openNewTicketModal()">
                            <i class="fas fa-plus"></i> √öj jegy
                        </button>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Jegy #</th>
                                    <th>T√°rgy</th>
                                    <th>Priorit√°s</th>
                                    <th>St√°tusz</th>
                                    <th>L√©trehozva</th>
                                    <th>M≈±veletek</th>
                                </tr>
                            </thead>
                            <tbody id="ticketsTable">
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td><span class="status overdue">Bet√∂lt√©s...</span></td>
                                    <td><span class="status pending">Bet√∂lt√©s...</span></td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Megtekint</button>
                                        <button class="btn btn-sm btn-delete">T√∂rl√©s</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="profile" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Profil be√°ll√≠t√°sok</h2>
                    
                    <div class="table-container">
                        <form id="profileForm" style="max-width: 600px;">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">C√©gn√©v</label>
                                <input type="text" id="companyName" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email c√≠m</label>
                                <input type="email" id="profileEmail" readonly style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; background-color: #f8f9fa;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Telefon</label>
                                <input type="tel" id="phone" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">C√≠m</label>
                                <textarea id="address" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; height: 80px;"></textarea>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Ment√©s</button>
                        </form>
                    </div>
                </div>

                <div id="settings" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Be√°ll√≠t√°sok</h2>
                    
                    <div class="table-container">
                        <h3 style="margin-bottom: 15px;">√ârtes√≠t√©si be√°ll√≠t√°sok</h3>
                        <form id="settingsForm">
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailInvoice">
                                    Email √©rtes√≠t√©s √∫j sz√°ml√°r√≥l
                                </label>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailTicket">
                                    Email √©rtes√≠t√©s t√°mogat√°si jegy st√°tusz v√°ltoz√°sr√≥l
                                </label>
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="smsNotifications">
                                    SMS √©rtes√≠t√©sek
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">Ment√©s</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- √öj jegy modal -->
    <div id="newTicketModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>√öj t√°mogat√°si jegy</h3>
                <span class="close" onclick="closeNewTicketModal()">&times;</span>
            </div>
            <form id="newTicketForm">
                <div class="form-group">
                    <label for="ticketSubject">T√°rgy *</label>
                    <input type="text" id="ticketSubject" required>
                </div>
                <div class="form-group">
                    <label for="ticketPriority">Priorit√°s *</label>
                    <select id="ticketPriority" required>
                        <option value="normal">Norm√°l</option>
                        <option value="high">Magas</option>
                        <option value="urgent">S√ºrg≈ës</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ticketCategory">Kateg√≥ria</label>
                    <select id="ticketCategory">
                        <option value="technical">Technikai probl√©ma</option>
                        <option value="billing">Sz√°ml√°z√°s</option>
                        <option value="general">√Åltal√°nos k√©rd√©s</option>
                        <option value="feature">√öj funkci√≥ k√©r√©se</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="ticketDescription">R√©szletes le√≠r√°s *</label>
                    <textarea id="ticketDescription" rows="5" required placeholder="√çrja le r√©szletesen a probl√©m√°t vagy k√©r√©s√©t..."></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeNewTicketModal()">M√©gse</button>
                    <button type="submit" class="btn btn-primary">Jegy l√©trehoz√°sa</button>
                </div>
            </form>
        </div>
    </div>

        <!-- T√∂rl√©s meger≈ës√≠t≈ë modal -->
    <div id="deleteConfirmModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="background-color: #dc3545; color: white;">
                <h3><i class="fas fa-exclamation-triangle"></i> Jegy t√∂rl√©se</h3>
                <span class="close" onclick="closeDeleteConfirmModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 30px; text-align: center;">
                <i class="fas fa-trash-alt" style="font-size: 48px; color: #dc3545; margin-bottom: 20px;"></i>
                <h4 style="margin-bottom: 15px; color: #2c3e50;">Biztosan t√∂r√∂lni szeretn√©?</h4>
                <p style="color: #6c757d; margin-bottom: 0;">
                    Ez a m≈±velet visszavonhatatlan. A t√°mogat√°si jegy v√©glegesen t√∂rl≈ëdik.
                </p>
            </div>
            <div class="modal-footer" style="gap: 10px;">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteConfirmModal()">
                    <i class="fas fa-times"></i> M√©gse
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">
                    <i class="fas fa-trash"></i> Igen, t√∂rl√∂m
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-firestore-compat.min.js"></script>

    <script>
          const firebaseConfig = {
            apiKey: "AIzaSyAXnAo-7BF6iKjNzYr0uoJbhlpCWNaS9s4",
            authDomain: "bitnova-backend.firebaseapp.com",
            projectId: "bitnova-backend",
            storageBucket: "bitnova-backend.firebasestorage.app",
            messagingSenderId: "312941837204",
            appId: "1:312941837204:web:f6e3ff0d44cab13f30ed81",
            measurementId: "G-VBW8LX8LDE"
          };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log('‚úÖ Firebase inicializ√°lva');
        } catch (error) {
            console.error('‚ùå Firebase inicializ√°l√°si hiba:', error);
            alert('Firebase inicializ√°l√°si hiba: ' + error.message);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .then(() => {
                console.log('‚úÖ Auth persistence be√°ll√≠tva');
            })
            .catch((error) => {
                console.error('Auth persistence hiba:', error);
            });

        auth.onAuthStateChanged(async (user) => {
            console.log('Auth state changed:', user);
            
            if (user) {
                console.log('‚úÖ Sikeres authentik√°ci√≥:', user.email);
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('profileEmail').value = user.email;
                
                await initializeUserData(user.uid, user.email);
                await loadUserData(user.uid);

                setupRealTimeListeners(user.uid);
                
            } else {
                console.log('‚ùå Nincs bejelentkezett felhaszn√°l√≥');
                setTimeout(() => {
                    window.location.href = 'bejelentkezes.html';
                }, 500);
            }
        }, (error) => {
            console.error('Auth state change error:', error);
            alert('Hiba az authentik√°ci√≥ sor√°n: ' + error.message);
        });

        function logout() {
            auth.signOut().then(() => {
                console.log('Sikeres kijelentkez√©s');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Kijelentkez√©si hiba:', error);
                alert('Hiba t√∂rt√©nt a kijelentkez√©s sor√°n: ' + error.message);
            });
        }

        async function initializeUserData(userId, email) {
            try {
                const userRef = db.collection('users').doc(userId);
                const doc = await userRef.get();
                
                if (!doc.exists) {
                    const defaultUserData = {
                        email: email,
                        companyName: '',
                        phone: '',
                        address: '',
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        settings: {
                            emailInvoice: true,
                            emailTicket: true,
                            smsNotifications: false
                        }
                    };
                    
                    await userRef.set(defaultUserData);
                    console.log('‚úÖ √öj felhaszn√°l√≥ dokumentum l√©trehozva');
                    
                    await createDefaultInvoices(userId);
                    await createDefaultServices(userId);
                    await createDefaultTickets(userId);
                    await createDefaultActivities(userId);
                    
                    console.log('‚úÖ Alap√©rtelmezett adatok l√©trehozva');
                }
            } catch (error) {
                console.error('Felhaszn√°l√≥ inicializ√°l√°si hiba:', error);
            }
        }

        async function createDefaultInvoices(userId) {
            const invoices = [
                {
                    userId: userId,
                    invoiceNumber: '2025-156',
                    amount: 45600,
                    status: 'pending',
                    date: firebase.firestore.Timestamp.now(),
                    description: 'Havi hosting szolg√°ltat√°s'
                },
                {
                    userId: userId,
                    invoiceNumber: '2025-155',
                    amount: 89500,
                    status: 'paid',
                    date: firebase.firestore.Timestamp.fromDate(new Date('2025-06-15')),
                    description: 'Szerver b√©rl√©s + domain'
                },
                {
                    userId: userId,
                    invoiceNumber: '2025-154',
                    amount: 23400,
                    status: 'overdue',
                    date: firebase.firestore.Timestamp.fromDate(new Date('2025-06-01')),
                    description: 'Kieg√©sz√≠t≈ë szolg√°ltat√°sok'
                }
            ];

            for (const invoice of invoices) {
                await db.collection('invoices').add(invoice);
            }
        }

        async function createDefaultServices(userId) {
            const services = [
                {
                    userId: userId,
                    name: 'Szerver hosting',
                    description: 'VPS szerver - 4GB RAM, 2 CPU',
                    status: 'active',
                    monthlyPrice: 45600,
                    icon: 'fas fa-server',
                    nextBilling: firebase.firestore.Timestamp.fromDate(new Date('2025-07-01'))
                },
                {
                    userId: userId,
                    name: 'Domain kezel√©s',
                    description: 'bitnova.hu + 2 aldomain',
                    status: 'active',
                    monthlyPrice: 12000,
                    icon: 'fas fa-globe',
                    nextBilling: firebase.firestore.Timestamp.fromDate(new Date('2025-12-15'))
                },
                {
                    userId: userId,
                    name: 'Biztons√°gi ment√©s',
                    description: 'Napi automatikus ment√©s',
                    status: 'active',
                    monthlyPrice: 8900,
                    icon: 'fas fa-shield-alt',
                    nextBilling: firebase.firestore.Timestamp.fromDate(new Date('2025-07-01'))
                }
            ];

            for (const service of services) {
                await db.collection('services').add(service);
            }
        }

        async function createDefaultTickets(userId) {
            const tickets = [
                {
                    userId: userId,
                    ticketNumber: 'T-2025-012',
                    subject: 'Weboldal bet√∂lt√©si id≈ë optimaliz√°l√°s',
                    priority: 'urgent',
                    status: 'in_progress',
                    createdAt: firebase.firestore.Timestamp.fromDate(new Date('2025-06-16'))
                },
                {
                    userId: userId,
                    ticketNumber: 'T-2025-011',
                    subject: 'Email be√°ll√≠t√°sok m√≥dos√≠t√°sa',
                    priority: 'normal',
                    status: 'open',
                    createdAt: firebase.firestore.Timestamp.fromDate(new Date('2025-06-14'))
                }
            ];

            for (const ticket of tickets) {
                await db.collection('tickets').add(ticket);
            }
        }

        async function createDefaultActivities(userId) {
            const activities = [
                {
                    userId: userId,
                    description: 'Sz√°mla #2025-156 l√©trehozva',
                    type: 'invoice',
                    status: 'F√ºgg≈ëben',
                    date: firebase.firestore.Timestamp.now()
                },
                {
                    userId: userId,
                    description: 'Szerver karbantart√°s befejezve',
                    type: 'maintenance',
                    status: 'K√©sz',
                    date: firebase.firestore.Timestamp.fromDate(new Date('2025-06-17'))
                },
                {
                    userId: userId,
                    description: '√öj t√°mogat√°si jegy: Weboldal lass√∫',
                    type: 'ticket',
                    status: 'Folyamatban',
                    date: firebase.firestore.Timestamp.fromDate(new Date('2025-06-16'))
                }
            ];

            for (const activity of activities) {
                await db.collection('activities').add(activity);
            }
        }

        async function loadUserData(userId) {
            try {
                console.log('üìä Adatok bet√∂lt√©se userId:', userId);
                
                await loadUserProfile(userId);
                await loadDashboardData(userId);
                await loadInvoices(userId);
                await loadServices(userId);
                await loadTickets(userId);
                await loadActivities(userId);
                
            } catch (error) {
                console.error('Adatbet√∂lt√©si hiba:', error);
            }
        }

        async function loadUserProfile(userId) {
            try {
                const doc = await db.collection('users').doc(userId).get();
                if (doc.exists) {
                    const data = doc.data();
                    console.log('üë§ Felhaszn√°l√≥i adatok:', data);
                    
                    document.getElementById('companyName').value = data.companyName || '';
                    document.getElementById('phone').value = data.phone || '';
                    document.getElementById('address').value = data.address || '';
                    
                    if (data.settings) {
                        document.getElementById('emailInvoice').checked = data.settings.emailInvoice || false;
                        document.getElementById('emailTicket').checked = data.settings.emailTicket || false;
                        document.getElementById('smsNotifications').checked = data.settings.smsNotifications || false;
                    }
                }
            } catch (error) {
                console.error('Profil bet√∂lt√©si hiba:', error);
            }
        }

        async function loadDashboardData(userId) {
            try {
                const invoicesSnapshot = await db.collection('invoices').where('userId', '==', userId).get();
                const servicesSnapshot = await db.collection('services').where('userId', '==', userId).get();
                const ticketsSnapshot = await db.collection('tickets').where('userId', '==', userId).get();
                
                document.getElementById('totalInvoices').textContent = invoicesSnapshot.size;
                document.getElementById('activeServices').textContent = servicesSnapshot.size;
                
                const openTickets = ticketsSnapshot.docs.filter(doc => doc.data().status !== 'closed').length;
                document.getElementById('openTickets').textContent = openTickets;
                
                let monthlyCost = 0;
                let pending = 0, paid = 0;
                let urgent = 0, normal = 0;
                let inactive = 0, active = 0;
                
                servicesSnapshot.forEach(doc => {
                    const service = doc.data();
                    if (service.monthlyPrice) monthlyCost += service.monthlyPrice;
                    if (service.status === 'active') active++;
                    else inactive++;
                });

                
                invoicesSnapshot.forEach(doc => {
                    const invoice = doc.data();
                    if (invoice.status === 'paid') paid++;
                    else pending++;
                });
                
                ticketsSnapshot.forEach(doc => {
                    const ticket = doc.data();
                    if (ticket.status !== 'closed') {
                        if (ticket.priority === 'urgent') urgent++;
                        else normal++;
                    }
                });
                
                document.getElementById('monthlyCost').textContent = monthlyCost.toLocaleString('hu-HU') + ' Ft';
                document.getElementById('invoicesSummary').textContent = `${pending} f√ºgg≈ëben, ${paid} kifizetve`;
                document.getElementById('ticketsSummary').textContent = `${urgent} s√ºrg≈ës, ${normal} norm√°l priorit√°s`;
                document.getElementById('servicesSummary').textContent = `${active} akt√≠v, ${inactive} inakt√≠v szolg√°ltat√°s`;
                
                console.log('üìä Dashboard adatok friss√≠tve');
            } catch (error) {
                console.error('Dashboard adatok bet√∂lt√©si hiba:', error);
            }
        }

        async function loadInvoices(userId) {
            try {
                const snapshot = await db.collection('invoices').where('userId', '==', userId).orderBy('date', 'desc').get();
                const tableBody = document.getElementById('invoicesTable');
                tableBody.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const invoice = doc.data();
                    const row = document.createElement('tr');
                    
                    const statusClass = invoice.status === 'paid' ? 'paid' : 
                                       invoice.status === 'pending' ? 'pending' : 'overdue';
                    
                    const statusText = invoice.status === 'paid' ? 'Kifizetve' : 
                                      invoice.status === 'pending' ? 'F√ºgg≈ëben' : 'Lej√°rt';
                    
                    row.innerHTML = `
                        <td>#${invoice.invoiceNumber}</td>
                        <td>${new Date(invoice.date.seconds * 1000).toLocaleDateString('hu-HU')}</td>
                        <td>${invoice.amount.toLocaleString('hu-HU')} Ft</td>
                        <td><span class="status ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="btn btn-sm btn-primary" onclick="viewInvoice('${doc.id}')">Megtekint</button>
                            <button class="btn btn-sm btn-secondary" onclick="downloadInvoice('${doc.id}')">Let√∂lt</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                console.log('üí∞ Sz√°ml√°k bet√∂ltve:', snapshot.size);
            } catch (error) {
                console.error('Sz√°ml√°k bet√∂lt√©si hiba:', error);
            }
        }

        async function loadServices(userId) {
            try {
                const snapshot = await db.collection('services').where('userId', '==', userId).get();
                const container = document.getElementById('servicesGrid');
                container.innerHTML = '';
                
                snapshot.forEach(doc => {
                    const service = doc.data();
                    const card = document.createElement('div');
                    card.className = 'card';
                    
                    const statusClass = service.status === 'active' ? 'paid' : 'pending';
                    const statusText = service.status === 'active' ? 'Akt√≠v' : 'Inakt√≠v';
                    
                    const nextBilling = service.nextBilling ? 
                        new Date(service.nextBilling.seconds * 1000).toLocaleDateString('hu-HU') : 'N/A';
                    
                    card.innerHTML = `
                        <div class="card-header">
                            <div class="card-title">
                                <i class="${service.icon || 'fas fa-server'}" style="color: #17a2b8;"></i>
                                ${service.name}
                            </div>
                        </div>
                        <div class="card-subtitle">${service.description}</div>
                        <div style="margin-top: 15px;">
                            <span class="status ${statusClass}">${statusText}</span>
                            <div style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                                K√∂vetkez≈ë sz√°ml√°z√°s: ${nextBilling}
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
                
                console.log('‚öôÔ∏è Szolg√°ltat√°sok bet√∂ltve:', snapshot.size);
            } catch (error) {
                console.error('Szolg√°ltat√°sok bet√∂lt√©si hiba:', error);
            }
        }

// A tickets bet√∂lt√©s befejez√©se (a f√©lbeszakadt r√©sz folytat√°sa)
async function loadTickets(userId) {
    try {
        const snapshot = await db.collection('tickets').where('userId', '==', userId).orderBy('createdAt', 'desc').get();
        const tableBody = document.getElementById('ticketsTable');
        tableBody.innerHTML = '';
        
        snapshot.forEach(doc => {
            const ticket = doc.data();
            const row = document.createElement('tr');
            
            const priorityClass = ticket.priority === 'urgent' ? 'overdue' : 
                                 ticket.priority === 'high' ? 'pending' : 'paid';
            
            const priorityText = ticket.priority === 'urgent' ? 'S√ºrg≈ës' : 
                                ticket.priority === 'high' ? 'Magas' : 'Norm√°l';
            
            const statusClass = ticket.status === 'open' ? 'pending' : 
                               ticket.status === 'in_progress' ? 'pending' : 'paid';
            
            const statusText = ticket.status === 'open' ? 'Nyitott' : 
                              ticket.status === 'in_progress' ? 'Folyamatban' : 'Lez√°rt';
            
            // Timestamp biztons√°gos kezel√©se
            let createdDate = 'N/A';
            if (ticket.createdAt) {
                if (ticket.createdAt.seconds) {
                    createdDate = new Date(ticket.createdAt.seconds * 1000).toLocaleDateString('hu-HU');
                } else if (ticket.createdAt.toDate) {
                    createdDate = ticket.createdAt.toDate().toLocaleDateString('hu-HU');
                }
            }
            
            row.innerHTML = `
                <td>#${ticket.ticketNumber}</td>
                <td>${ticket.subject}</td>
                <td><span class="status ${priorityClass}">${priorityText}</span></td>
                <td><span class="status ${statusClass}">${statusText}</span></td>
                <td>${createdDate}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="viewTicket('${doc.id}')">Megtekint</button>
                    <button class="btn btn-sm btn-delete" onclick="deleteTicket('${doc.id}')">T√∂rl√©s</button>
                </td>
            `;
            tableBody.appendChild(row);
        });
        
        console.log('üé´ Jegyek bet√∂ltve:', snapshot.size);
    } catch (error) {
        console.error('Jegyek bet√∂lt√©si hiba:', error);
        // √úres t√°bl√°zat megjelen√≠t√©se hiba eset√©n
        const tableBody = document.getElementById('ticketsTable');
        tableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6c757d;">Nincsenek t√°mogat√°si jegyek</td></tr>';
    }
}

async function loadActivities(userId) {
    try {
        const snapshot = await db.collection('activities').where('userId', '==', userId).orderBy('date', 'desc').limit(10).get();
        const tableBody = document.getElementById('activitiesTable');
        tableBody.innerHTML = '';
        
        snapshot.forEach(doc => {
            const activity = doc.data();
            const row = document.createElement('tr');
            
            const statusClass = activity.status === 'K√©sz' ? 'paid' : 
                               activity.status === 'F√ºgg≈ëben' ? 'pending' : 'pending';
            
            row.innerHTML = `
                <td>${new Date(activity.date.seconds * 1000).toLocaleDateString('hu-HU')}</td>
                <td>${activity.description}</td>
                <td><span class="status ${statusClass}">${activity.status}</span></td>
            `;
            tableBody.appendChild(row);
        });
        
        console.log('üìã Tev√©kenys√©gek bet√∂ltve:', snapshot.size);
    } catch (error) {
        console.error('Tev√©kenys√©gek bet√∂lt√©si hiba:', error);
    }
}

// Navig√°ci√≥ kezel√©se
function showSection(sectionId) {
    // √ñsszes szekci√≥ elrejt√©se
    const sections = document.querySelectorAll('.section');
    sections.forEach(section => section.classList.add('hidden'));
    
    // Akt√≠v nav elem elt√°vol√≠t√°sa
    const navItems = document.querySelectorAll('.nav-item');
    navItems.forEach(item => item.classList.remove('active'));
    
    // Kiv√°lasztott szekci√≥ megjelen√≠t√©se
    document.getElementById(sectionId).classList.remove('hidden');
    
    // Akt√≠v nav elem be√°ll√≠t√°sa - csak ha van event
    if (typeof event !== 'undefined' && event.target) {
        event.target.closest('.nav-item').classList.add('active');
    } else {
        // Programatikus h√≠v√°s eset√©n megkeress√ºk a megfelel≈ë nav elemet
        const targetNavItem = document.querySelector(`[onclick="showSection('${sectionId}')"]`);
        if (targetNavItem) {
            targetNavItem.classList.add('active');
        }
    }
}

// Profil form kezel√©se
document.getElementById('profileForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const profileData = {
            companyName: document.getElementById('companyName').value,
            phone: document.getElementById('phone').value,
            address: document.getElementById('address').value,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection('users').doc(user.uid).update(profileData);
        
        // Siker √ºzenet megjelen√≠t√©se
        showNotification('Profil sikeresen mentve!', 'success');
        
        console.log('‚úÖ Profil mentve');
    } catch (error) {
        console.error('Profil ment√©si hiba:', error);
        showNotification('Hiba a profil ment√©se sor√°n!', 'error');
    }
});

// Be√°ll√≠t√°sok form kezel√©se
document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) return;
    
    try {
        const settings = {
            emailInvoice: document.getElementById('emailInvoice').checked,
            emailTicket: document.getElementById('emailTicket').checked,
            smsNotifications: document.getElementById('smsNotifications').checked
        };
        
        await db.collection('users').doc(user.uid).update({
            settings: settings,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showNotification('Be√°ll√≠t√°sok sikeresen mentve!', 'success');
        
        console.log('‚úÖ Be√°ll√≠t√°sok mentve');
    } catch (error) {
        console.error('Be√°ll√≠t√°sok ment√©si hiba:', error);
        showNotification('Hiba a be√°ll√≠t√°sok ment√©se sor√°n!', 'error');
    }
});

// √ârtes√≠t√©s megjelen√≠t√©se
function showNotification(message, type = 'info') {
    // L√©trehozzuk az √©rtes√≠t√©si elemet
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
        color: white;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 1000;
        font-weight: 500;
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    
    // CSS anim√°ci√≥ hozz√°ad√°sa
    if (!document.getElementById('notification-styles')) {
        const style = document.createElement('style');
        style.id = 'notification-styles';
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    }
    
    document.body.appendChild(notification);
    
    // 3 m√°sodperc ut√°n elt√°vol√≠t√°s
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Seg√©df√ºggv√©nyek a m≈±veletek kezel√©s√©hez
function viewInvoice(invoiceId) {
    console.log('Sz√°mla megtekint√©se:', invoiceId);
    showNotification('Sz√°mla megtekint√©s funkci√≥ fejleszt√©s alatt', 'info');
}

function downloadInvoice(invoiceId) {
    console.log('Sz√°mla let√∂lt√©se:', invoiceId);
    showNotification('Sz√°mla let√∂lt√©s funkci√≥ fejleszt√©s alatt', 'info');
}

function viewTicket(ticketId) {
    console.log('Jegy megtekint√©se:', ticketId);
    showNotification('Jegy megtekint√©s funkci√≥ fejleszt√©s alatt', 'info');
}

async function deleteTicket(ticketId) {
    // Meger≈ës√≠t√©s k√©r√©se
    if (!confirm('Biztosan t√∂r√∂lni szeretn√© ezt a t√°mogat√°si jegyet?')) {
        return;
    }
    
    try {
        // Loading √°llapot (ha van gomb)
        const deleteBtn = event?.target;
        if (deleteBtn) {
            deleteBtn.textContent = 'T√∂rl√©s...';
            deleteBtn.disabled = true;
        }
        
        // Jegy t√∂rl√©se Firestore-b√≥l
        await db.collection('tickets').doc(ticketId).delete();
        console.log('‚úÖ Jegy t√∂r√∂lve:', ticketId);
        
        // Aktivit√°s napl√≥z√°sa
        const user = auth.currentUser;
        if (user) {
            await db.collection('activities').add({
                userId: user.uid,
                description: 'T√°mogat√°si jegy t√∂r√∂lve',
                type: 'ticket',
                status: 'T√∂r√∂lve',
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Siker √ºzenet
        showNotification('T√°mogat√°si jegy sikeresen t√∂r√∂lve!', 'success');
        
    } catch (error) {
        console.error('Jegy t√∂rl√©si hiba:', error);
        showNotification('Hiba a jegy t√∂rl√©se sor√°n!', 'error');
    } finally {
        // Loading √°llapot vissza√°ll√≠t√°sa
        if (deleteBtn) {
            deleteBtn.textContent = 'T√∂rl√©s';
            deleteBtn.disabled = false;
        }
    }
}
        
// Val√≥s idej≈± adatfriss√≠t√©s be√°ll√≠t√°sa
function setupRealTimeListeners(userId) {
    // Sz√°ml√°k val√≥s idej≈± figyel√©se
    db.collection('invoices').where('userId', '==', userId)
        .onSnapshot((snapshot) => {
            console.log('üìä Sz√°ml√°k friss√≠tve val√≥s id≈ëben');
            loadInvoices(userId);
            loadDashboardData(userId);
        });
    
    // Szolg√°ltat√°sok val√≥s idej≈± figyel√©se  
    db.collection('services').where('userId', '==', userId)
        .onSnapshot((snapshot) => {
            console.log('‚öôÔ∏è Szolg√°ltat√°sok friss√≠tve val√≥s id≈ëben');
            loadServices(userId);
            loadDashboardData(userId);
        });
    
    // Jegyek val√≥s idej≈± figyel√©se
    db.collection('tickets').where('userId', '==', userId)
        .onSnapshot((snapshot) => {
            console.log('üé´ Jegyek friss√≠tve val√≥s id≈ëben');
            loadTickets(userId);
            loadDashboardData(userId);
        });
    
    // Tev√©kenys√©gek val√≥s idej≈± figyel√©se
    db.collection('activities').where('userId', '==', userId)
        .onSnapshot((snapshot) => {
            console.log('üìã Tev√©kenys√©gek friss√≠tve val√≥s id≈ëben');
            loadActivities(userId);
        });
}

// √öj jegy modal megnyit√°sa
function openNewTicketModal() {
    document.getElementById('newTicketModal').style.display = 'block';
    document.body.style.overflow = 'hidden'; // Scroll letilt√°sa
}

// √öj jegy modal bez√°r√°sa
function closeNewTicketModal() {
    document.getElementById('newTicketModal').style.display = 'none';
    document.body.style.overflow = 'auto'; // Scroll vissza√°ll√≠t√°sa
    document.getElementById('newTicketForm').reset();
}

// Modal bez√°r√°sa ESC gombbal vagy h√°tt√©rre kattint√°ssal
window.onclick = function(event) {
    const modal = document.getElementById('newTicketModal');
    const deleteModal = document.getElementById('deleteConfirmModal');
    if (event.target == modal) {
        closeNewTicketModal();
    }
    if (event.target == deleteModal) {
        closeDeleteConfirmModal();
    }
}

document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeNewTicketModal();
        closeDeleteConfirmModal();
    }
});

// √öj jegy form kezel√©se
document.getElementById('newTicketForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const user = auth.currentUser;
    if (!user) {
        showNotification('Hiba: Nincs bejelentkezett felhaszn√°l√≥!', 'error');
        return;
    }

    const submitBtn = e.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.textContent;
    
    try {
        // Loading √°llapot
        
        submitBtn.textContent = 'L√©trehoz√°s...';
        submitBtn.disabled = true;
        
        // Jegy sz√°m gener√°l√°sa
        const now = new Date();
        const year = now.getFullYear();
        const ticketNumber = `T-${year}-${String(Math.floor(Math.random() * 999) + 1).padStart(3, '0')}`;
        
        // √öj jegy adatok
        const newTicket = {
            userId: user.uid,
            ticketNumber: ticketNumber,
            subject: document.getElementById('ticketSubject').value.trim(),
            priority: document.getElementById('ticketPriority').value,
            category: document.getElementById('ticketCategory').value,
            description: document.getElementById('ticketDescription').value.trim(),
            status: 'open',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        console.log('√öj jegy ment√©se:', newTicket);
        
        // Jegy ment√©se Firestore-ba
        const docRef = await db.collection('tickets').add(newTicket);
        console.log('‚úÖ Jegy mentve, ID:', docRef.id);
        
        // Aktivit√°s napl√≥z√°sa
        await db.collection('activities').add({
            userId: user.uid,
            description: `√öj t√°mogat√°si jegy l√©trehozva: ${newTicket.subject}`,
            type: 'ticket',
            status: 'Nyitott',
            date: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        console.log('‚úÖ √öj jegy l√©trehozva:', ticketNumber);
        
        // Siker √©rtes√≠t√©s
        showNotification(`Jegy sikeresen l√©trehozva: ${ticketNumber}`, 'success');
        
        // Modal bez√°r√°sa
        closeNewTicketModal();
        
        // Jegyek szekci√≥ megjelen√≠t√©se
        showSection('tickets');
        
    } catch (error) {
        console.error('Jegy l√©trehoz√°si hiba:', error);
        let errorMessage = 'Hiba a jegy l√©trehoz√°sa sor√°n';
        
        if (error.code === 'permission-denied') {
            errorMessage = 'Nincs jogosults√°g a jegy l√©trehoz√°s√°hoz. K√©rj√ºk, jelentkezzen be √∫jra.';
        } else if (error.message) {
            errorMessage += ': ' + error.message;
        }
        
        showNotification(errorMessage, 'error');
    } finally {
        // Loading √°llapot vissza√°ll√≠t√°sa
        const submitBtn = e.target.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.textContent = originalText;
            submitBtn.disabled = false;
        }
    }
});

// Glob√°lis v√°ltoz√≥ a t√∂rlend≈ë jegy ID t√°rol√°s√°hoz
let ticketToDelete = null;

// T√∂rl√©s modal megnyit√°sa
function openDeleteConfirmModal(ticketId) {
    ticketToDelete = ticketId;
    document.getElementById('deleteConfirmModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
}

// T√∂rl√©s modal bez√°r√°sa
function closeDeleteConfirmModal() {
    ticketToDelete = null;
    document.getElementById('deleteConfirmModal').style.display = 'none';
    document.body.style.overflow = 'auto';
}

// T√∂rl√©s meger≈ës√≠t√©se
async function confirmDelete() {
    if (!ticketToDelete) return;
    
    try {
        // Loading √°llapot
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> T√∂rl√©s...';
        confirmBtn.disabled = true;
        
        // Jegy t√∂rl√©se Firestore-b√≥l
        await db.collection('tickets').doc(ticketToDelete).delete();
        console.log('‚úÖ Jegy t√∂r√∂lve:', ticketToDelete);
        
        // Aktivit√°s napl√≥z√°sa
        const user = auth.currentUser;
        if (user) {
            await db.collection('activities').add({
                userId: user.uid,
                description: 'T√°mogat√°si jegy t√∂r√∂lve',
                type: 'ticket',
                status: 'T√∂r√∂lve',
                date: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
        
        // Siker √ºzenet
        showNotification('T√°mogat√°si jegy sikeresen t√∂r√∂lve!', 'success');
        
        // Modal bez√°r√°sa
        closeDeleteConfirmModal();
        
    } catch (error) {
        console.error('Jegy t√∂rl√©si hiba:', error);
        showNotification('Hiba a jegy t√∂rl√©se sor√°n!', 'error');
        
        // Gomb vissza√°ll√≠t√°sa hiba eset√©n
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        confirmBtn.innerHTML = '<i class="fas fa-trash"></i> Igen, t√∂rl√∂m';
        confirmBtn.disabled = false;
    }
}

// Eredeti deleteTicket f√ºggv√©ny m√≥dos√≠t√°sa
function deleteTicket(ticketId) {
    openDeleteConfirmModal(ticketId);
}


// Inicializ√°l√°s befejez√©se
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Dashboard inicializ√°lva');
});
</script>
</body>
</html>
