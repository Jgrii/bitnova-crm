<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BitNova CRM Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="dashboardcss.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <div class="logo">
                <i class="fas fa-users-cog"></i>
                BitNova CRM Dashboard
            </div>
            <div class="user-info">
                <span id="adminEmail">Admin bet√∂lt√©s...</span>
                <button class="logout-btn" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Kil√©p√©s
                </button>
            </div>
        </header>

        <div class="main-content">
            <nav class="sidebar">
                <a href="#" class="nav-item active" onclick="showSection('overview')">
                    <i class="fas fa-chart-pie"></i> √Åttekint√©s
                </a>
                <a href="#" class="nav-item" onclick="showSection('users')">
                    <i class="fas fa-users"></i> Felhaszn√°l√≥k
                </a>
                <a href="#" class="nav-item" onclick="showSection('all-invoices')">
                    <i class="fas fa-file-invoice-dollar"></i> √ñsszes sz√°mla
                </a>
                <a href="#" class="nav-item" onclick="showSection('all-services')">
                    <i class="fas fa-server"></i> Szolg√°ltat√°sok
                </a>
                <a href="#" class="nav-item" onclick="showSection('all-tickets')">
                    <i class="fas fa-headset"></i> T√°mogat√°si jegyek
                </a>
                <a href="#" class="nav-item" onclick="showSection('activities')">
                    <i class="fas fa-list-alt"></i> Aktivit√°sok
                </a>
                <a href="#" class="nav-item" onclick="showSection('analytics')">
                    <i class="fas fa-chart-bar"></i> Analitika
                </a>
                <a href="#" class="nav-item" onclick="showSection('settings')">
                    <i class="fas fa-cog"></i> Rendszer be√°ll√≠t√°sok
                </a>
            </nav>

            <main class="content">
                <!-- √Åttekint√©s szekci√≥ -->
                <div id="overview" class="section">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">CRM √Åttekint√©s</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-users" style="color: #667eea;"></i>
                                    √ñsszes felhaszn√°l√≥
                                </div>
                            </div>
                            <div class="card-value" id="totalUsers">Bet√∂lt√©s...</div>
                            <div class="card-subtitle" id="usersSummary">Bet√∂lt√©s...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-dollar-sign" style="color: #28a745;"></i>
                                    Havi bev√©tel
                                </div>
                            </div>
                            <div class="card-value" id="monthlyRevenue">Bet√∂lt√©s...</div>
                            <div class="card-subtitle">Akt√≠v szolg√°ltat√°sokb√≥l</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-ticket-alt" style="color: #ffc107;"></i>
                                    Akt√≠v jegyek
                                </div>
                            </div>
                            <div class="card-value" id="activeTickets">Bet√∂lt√©s...</div>
                            <div class="card-subtitle" id="ticketsSummary">Bet√∂lt√©s...</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                                    S√ºrg≈ës feladatok
                                </div>
                            </div>
                            <div class="card-value" id="urgentTasks">Bet√∂lt√©s...</div>
                            <div class="card-subtitle" id="urgentSummary">Bet√∂lt√©s...</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Legut√≥bbi rendszer esem√©nyek</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>D√°tum</th>
                                    <th>Felhaszn√°l√≥</th>
                                    <th>Esem√©ny</th>
                                    <th>St√°tusz</th>
                                </tr>
                            </thead>
                            <tbody id="systemEventsTable">
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td><span class="status pending">Bet√∂lt√©s...</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Felhaszn√°l√≥k szekci√≥ -->
                <div id="users" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">Felhaszn√°l√≥k kezel√©se</h2>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="userSearch" placeholder="Keres√©s felhaszn√°l√≥k k√∂z√∂tt..." style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px; width: 250px;">
                            <button class="btn btn-primary" onclick="exportUsers()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Email</th>
                                    <th>C√©gn√©v</th>
                                    <th>Regisztr√°ci√≥</th>
                                    <th>Szolg√°ltat√°sok</th>
                                    <th>Nyitott jegyek</th>
                                    <th>Havi k√∂lts√©g</th>
                                    <th>M≈±veletek</th>
                                </tr>
                            </thead>
                            <tbody id="usersTable">
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">R√©szletek</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- √ñsszes sz√°mla szekci√≥ -->
                <div id="all-invoices" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">√ñsszes sz√°mla</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="invoiceStatusFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Minden st√°tusz</option>
                                <option value="pending">F√ºgg≈ëben</option>
                                <option value="paid">Kifizetve</option>
                                <option value="overdue">Lej√°rt</option>
                            </select>
                            <input type="date" id="invoiceDateFrom" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                            <input type="date" id="invoiceDateTo" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                            <button class="btn btn-secondary" onclick="filterInvoices()">
                                <i class="fas fa-filter"></i> Sz≈±r√©s
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Sz√°mlasz√°m</th>
                                    <th>Felhaszn√°l√≥</th>
                                    <th>D√°tum</th>
                                    <th>√ñsszeg</th>
                                    <th>St√°tusz</th>
                                    <th>M≈±veletek</th>
                                </tr>
                            </thead>
                            <tbody id="allInvoicesTable">
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td><span class="status pending">Bet√∂lt√©s...</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">Megtekint</button>
                                        <button class="btn btn-sm btn-secondary">√Ållapot</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Szolg√°ltat√°sok szekci√≥ -->
                <div id="all-services" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">√ñsszes szolg√°ltat√°s</h2>
                    
                    <div class="dashboard-grid" id="allServicesGrid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-server" style="color: #17a2b8;"></i>
                                    Bet√∂lt√©s...
                                </div>
                            </div>
                            <div class="card-subtitle">Bet√∂lt√©s...</div>
                            <div style="margin-top: 15px;">
                                <span class="status paid">Bet√∂lt√©s...</span>
                                <div style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                                    Felhaszn√°l√≥: Bet√∂lt√©s...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- T√°mogat√°si jegyek szekci√≥ -->
                <div id="all-tickets" class="section hidden">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #2c3e50;">√ñsszes t√°mogat√°si jegy</h2>
                        <div style="display: flex; gap: 10px;">
                            <select id="ticketStatusFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Minden st√°tusz</option>
                                <option value="open">Nyitott</option>
                                <option value="in_progress">Folyamatban</option>
                                <option value="closed">Lez√°rt</option>
                            </select>
                            <select id="ticketPriorityFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">Minden priorit√°s</option>
                                <option value="normal">Norm√°l</option>
                                <option value="high">Magas</option>
                                <option value="urgent">S√ºrg≈ës</option>
                            </select>
                            <button class="btn btn-secondary" onclick="filterTickets()">
                                <i class="fas fa-filter"></i> Sz≈±r√©s
                            </button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Jegy #</th>
                                    <th>Felhaszn√°l√≥</th>
                                    <th>T√°rgy</th>
                                    <th>Priorit√°s</th>
                                    <th>St√°tusz</th>
                                    <th>L√©trehozva</th>
                                    <th>M≈±veletek</th>
                                </tr>
                            </thead>
                            <tbody id="allTicketsTable">
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td><span class="status overdue">Bet√∂lt√©s...</span></td>
                                    <td><span class="status pending">Bet√∂lt√©s...</span></td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>
                                        <button class="btn btn-sm btn-primary">V√°lasz</button>
                                        <button class="btn btn-sm btn-secondary">√Ållapot</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- aktivit√°sok -->
                <div id="activities" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Rendszer aktivit√°sok</h2>
                
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>D√°tum</th>
                                    <th>Felhaszn√°l√≥</th>
                                    <th>Esem√©ny</th>
                                    <th>St√°tusz</th>
                                </tr>
                            </thead>
                            <tbody id="allActivitiesTable">
                                <tr><td colspan="4">Bet√∂lt√©s...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>


                <!-- Analitika szekci√≥ -->
                <div id="analytics" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Rendszer analitika</h2>
                    
                    <div class="dashboard-grid">
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-chart-line" style="color: #28a745;"></i>
                                    Havi n√∂veked√©s
                                </div>
                            </div>
                            <div class="card-value" id="monthlyGrowth">Bet√∂lt√©s...</div>
                            <div class="card-subtitle">√öj felhaszn√°l√≥k</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-clock" style="color: #17a2b8;"></i>
                                    √Åtlag v√°laszid≈ë
                                </div>
                            </div>
                            <div class="card-value" id="avgResponseTime">Bet√∂lt√©s...</div>
                            <div class="card-subtitle">T√°mogat√°si jegyekre</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-star" style="color: #ffc107;"></i>
                                    √úgyf√©l el√©gedetts√©g
                                </div>
                            </div>
                            <div class="card-value" id="customerSatisfaction">Bet√∂lt√©s...</div>
                            <div class="card-subtitle">5-√∂s sk√°l√°n</div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">
                                    <i class="fas fa-percentage" style="color: #dc3545;"></i>
                                    Lemorzsol√≥d√°s
                                </div>
                            </div>
                            <div class="card-value" id="churnRate">Bet√∂lt√©s...</div>
                            <div class="card-subtitle">Havi ar√°ny</div>
                        </div>
                    </div>

                    <div class="table-container">
                        <h3 style="color: #2c3e50; margin-bottom: 15px;">Top szolg√°ltat√°sok</h3>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Szolg√°ltat√°s</th>
                                    <th>Akt√≠v el≈ëfizet≈ëk</th>
                                    <th>Havi bev√©tel</th>
                                    <th>N√∂veked√©s</th>
                                </tr>
                            </thead>
                            <tbody id="topServicesTable">
                                <tr>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td>Bet√∂lt√©s...</td>
                                    <td><span class="status paid">Bet√∂lt√©s...</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Be√°ll√≠t√°sok szekci√≥ -->
                <div id="settings" class="section hidden">
                    <h2 style="margin-bottom: 30px; color: #2c3e50;">Rendszer be√°ll√≠t√°sok</h2>
                    
                    <div class="table-container">
                        <h3 style="margin-bottom: 15px;">√Åltal√°nos be√°ll√≠t√°sok</h3>
                        <form id="systemSettingsForm">
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Rendszer n√©v</label>
                                <input type="text" id="systemName" value="BitNova CRM" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Admin email</label>
                                <input type="email" id="adminEmail" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="autoBackup">
                                    Automatikus biztons√°gi ment√©s
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="emailNotifications">
                                    Email √©rtes√≠t√©sek adminoknak
                                </label>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <input type="checkbox" id="maintenanceMode">
                                    Karbantart√°si m√≥d
                                </label>
                            </div>
                            
                            <button type="submit" class="btn btn-primary">Be√°ll√≠t√°sok ment√©se</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Felhaszn√°l√≥ r√©szletek modal -->
    <div id="userDetailsModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="userDetailsTitle">Felhaszn√°l√≥ r√©szletei</h3>
                <span class="close" onclick="closeUserDetailsModal()">&times;</span>
            </div>
            <div class="modal-body" id="userDetailsContent">
                <!-- Dinamikusan t√∂lt≈ëdik -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeUserDetailsModal()">Bez√°r√°s</button>
            </div>
        </div>
    </div>

    <!-- √Åltal√°nos √©rtes√≠t√©si modal -->
    <div id="notificationModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="notificationTitle">√ârtes√≠t√©s</h3>
                <button class="custom-modal-close" onclick="closeNotificationModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <div id="notificationIcon"></div>
                <p id="notificationMessage">√úzenet</p>
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="closeNotificationModal()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Input modal -->
    <div id="inputModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="inputTitle">Adatok megad√°sa</h3>
                <button class="custom-modal-close" onclick="closeInputModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <p id="inputMessage">K√©rj√ºk adja meg az adatokat:</p>
                <input type="text" id="inputField" placeholder="√çrja be...">
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeInputModal()">M√©gse</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmInput()">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Textarea modal -->
    <div id="textareaModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="textareaTitle">√úzenet √≠r√°sa</h3>
                <button class="custom-modal-close" onclick="closeTextareaModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <p id="textareaMessage">√çrja be az √ºzenetet:</p>
                <textarea id="textareaField" rows="5" placeholder="√çrja be az √ºzenetet..."></textarea>
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeTextareaModal()">M√©gse</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmTextarea()">K√ºld√©s</button>
            </div>
        </div>
    </div>
    
    <!-- Select modal -->
    <div id="selectModal" class="custom-modal">
        <div class="custom-modal-content">
            <div class="custom-modal-header">
                <h3 class="custom-modal-title" id="selectTitle">V√°lasszon opci√≥t</h3>
                <button class="custom-modal-close" onclick="closeSelectModal()">&times;</button>
            </div>
            <div class="custom-modal-body">
                <p id="selectMessage">V√°lassza ki a megfelel≈ë opci√≥t:</p>
                <select id="selectField">
                    <option value="">V√°lasszon...</option>
                </select>
            </div>
            <div class="custom-modal-footer">
                <button class="modal-btn modal-btn-secondary" onclick="closeSelectModal()">M√©gse</button>
                <button class="modal-btn modal-btn-primary" onclick="confirmSelect()">OK</button>
            </div>
        </div>
    </div>

    <!-- T√∂rl√©s modal -->
    <div id="deleteActivityModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="deleteActivityTitle">Aktivit√°s t√∂rl√©se</h3>
                <span class="close" onclick="closeDeleteActivityModal()">&times;</span>
            </div>
            <div class="modal-body" id="deleteActivityContent">
                <p>Biztosan t√∂r√∂lni szeretn√©d ezt az aktivit√°st?</p>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 10px 0;">
                    <strong>D√°tum:</strong> <span id="deleteActivityDate"></span><br>
                    <strong>Felhaszn√°l√≥:</strong> <span id="deleteActivityUser"></span><br>
                    <strong>Esem√©ny:</strong> <span id="deleteActivityEvent"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteActivityModal()">M√©gse</button>
                <button type="button" class="btn btn-delete" id="confirmDeleteBtn">T√∂rl√©s</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-app-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-auth-compat.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.15.0/firebase-firestore-compat.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAXnAo-7BF6iKjNzYr0uoJbhlpCWNaS9s4",
            authDomain: "bitnova-backend.firebaseapp.com",
            projectId: "bitnova-backend",
            storageBucket: "bitnova-backend.firebasestorage.app",
            messagingSenderId: "312941837204",
            appId: "1:312941837204:web:f6e3ff0d44cab13f30ed81",
            measurementId: "G-VBW8LX8LDE"
        };

        try {
            firebase.initializeApp(firebaseConfig);
            console.log('‚úÖ Firebase inicializ√°lva');
        } catch (error) {
            console.error('‚ùå Firebase inicializ√°l√°si hiba:', error);
            alert('Firebase inicializ√°l√°si hiba: ' + error.message);
        }
        
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        let allUsers = [];
        let allInvoices = [];
        let allTickets = [];
        let allServices = [];

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                
                console.log('‚úÖ Admin bejelentkez√©s:', user.email);
                document.getElementById('adminEmail').textContent = user.email;
                
                await loadAllData();
                setupRealTimeListeners();
                
            } else {
                console.log('‚ùå Nincs bejelentkezett admin');
                window.location.href = 'admin-login.html';
            }
        });

        function logout() {
            auth.signOut().then(() => {
                console.log('Sikeres kijelentkez√©s');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Kijelentkez√©si hiba:', error);
            });
        }

        async function loadAllData() {
            try {
                await loadAllUsers();

                // Majd a t√∂bbi adatot
                await Promise.all([
                    loadAllInvoices(),
                    loadAllServices(),
                    loadAllTickets(),
                    loadSystemEvents(),
                    loadAnalytics(),
                    loadAllActivities()
                ]);
                
                updateOverviewStats();
                console.log('‚úÖ Minden adat bet√∂ltve');
            } catch (error) {
                console.error('Adatbet√∂lt√©si hiba:', error);
            }
        }

        async function loadAllUsers() {
            try {
                const snapshot = await db.collection('users').orderBy('createdAt', 'desc').get();
                allUsers = [];
                
                for (const doc of snapshot.docs) {
                    const userData = { id: doc.id, ...doc.data() };
                    
                    // Sz√°moljuk ki a felhaszn√°l√≥ statisztik√°it
                    const userStats = await getUserStats(doc.id);
                    userData.stats = userStats;
                    
                    allUsers.push(userData);
                }
                
                displayUsers(allUsers);
                console.log('üë• Felhaszn√°l√≥k bet√∂ltve:', allUsers.length);
            } catch (error) {
                console.error('Felhaszn√°l√≥k bet√∂lt√©si hiba:', error);
            }
        }

        async function getUserStats(userId) {
            try {
                const [servicesSnap, ticketsSnap, invoicesSnap] = await Promise.all([
                    db.collection('services').where('userId', '==', userId).get(),
                    db.collection('tickets').where('userId', '==', userId).where('status', '!=', 'closed').get(),
                    db.collection('invoices').where('userId', '==', userId).get()
                ]);

                let monthlyCost = 0;
                servicesSnap.forEach(doc => {
                    const service = doc.data();
                    if (service.status === 'active' && service.monthlyPrice) {
                        monthlyCost += service.monthlyPrice;
                    }
                });

                return {
                    services: servicesSnap.size,
                    openTickets: ticketsSnap.size,
                    monthlyCost: monthlyCost,
                    totalInvoices: invoicesSnap.size
                };
            } catch (error) {
                console.error('Felhaszn√°l√≥ statisztik√°k hiba:', error);
                return { services: 0, openTickets: 0, monthlyCost: 0, totalInvoices: 0 };
            }
        }

        function displayUsers(users) {
            const tableBody = document.getElementById('usersTable');
            tableBody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                
                const createdDate = user.createdAt ? 
                    new Date(user.createdAt.seconds * 1000).toLocaleDateString('hu-HU') : 'N/A';
                
                row.innerHTML = `
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.companyName || 'Nincs megadva'}</td>
                    <td>${createdDate}</td>
                    <td>${user.stats?.services || 0}</td>
                    <td>${user.stats?.openTickets || 0}</td>
                    <td>${(user.stats?.monthlyCost || 0).toLocaleString('hu-HU')} Ft</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="showUserDetails('${user.id}')">R√©szletek</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function loadAllInvoices() {
            try {
                const snapshot = await db.collection('invoices').orderBy('date', 'desc').get();
                allInvoices = [];
                
                for (const doc of snapshot.docs) {
                    const invoice = { id: doc.id, ...doc.data() };
                    
                    // Keress√ºk meg a felhaszn√°l√≥ adatait
                    const user = allUsers.find(u => u.id === invoice.userId);
                    invoice.userEmail = user?.email || 'Ismeretlen';
                    
                    allInvoices.push(invoice);
                }
                
                displayInvoices(allInvoices);
                console.log('üí∞ Sz√°ml√°k bet√∂ltve:', allInvoices.length);
            } catch (error) {
                console.error('Sz√°ml√°k bet√∂lt√©si hiba:', error);
            }
        }

        function displayInvoices(invoices) {
            const tableBody = document.getElementById('allInvoicesTable');
            tableBody.innerHTML = '';
            
            invoices.forEach(invoice => {
                const row = document.createElement('tr');
                
                const statusClass = invoice.status === 'paid' ? 'paid' : 
                                   invoice.status === 'pending' ? 'pending' : 'overdue';
                
                const statusText = invoice.status === 'paid' ? 'Kifizetve' : 
                                  invoice.status === 'pending' ? 'F√ºgg≈ëben' : 'Lej√°rt';
                
                row.innerHTML = `
                    <td>#${invoice.invoiceNumber}</td>
                    <td>${invoice.userEmail}</td>
                    <td>${new Date(invoice.date.seconds * 1000).toLocaleDateString('hu-HU')}</td>
                    <td>${invoice.amount.toLocaleString('hu-HU')} Ft</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewInvoice('${invoice.id}')">Megtekint</button>
                        <button class="btn btn-sm btn-secondary" onclick="changeInvoiceStatus('${invoice.id}')">√Ållapot</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        async function loadAllServices() {
            try {
                const snapshot = await db.collection('services').get();
                allServices = [];
                
                for (const doc of snapshot.docs) {
                    const service = { id: doc.id, ...doc.data() };
                    
                    const user = allUsers.find(u => u.id === service.userId);
                    service.userEmail = user?.email || 'Ismeretlen';
                    
                    allServices.push(service);
                }
                
                displayServices(allServices);
                console.log('‚öôÔ∏è Szolg√°ltat√°sok bet√∂ltve:', allServices.length);
            } catch (error) {
                console.error('Szolg√°ltat√°sok bet√∂lt√©si hiba:', error);
            }
        }

        // CRM Dashboard - Hi√°nyz√≥ JavaScript funkci√≥k
        // Ezt a k√≥dot add hozz√° a megl√©v≈ë script tag-hez vagy k√ºl√∂n f√°jlk√©nt
        
        // Szolg√°ltat√°sok megjelen√≠t√©se folytat√°sa (a displayServices f√ºggv√©ny befejez√©se)
        function displayServices(services) {
            const container = document.getElementById('allServicesGrid');
            container.innerHTML = '';
            
            services.forEach(service => {
                const card = document.createElement('div');
                card.className = 'card';
                
                const statusClass = service.status === 'active' ? 'paid' : 
                                   service.status === 'suspended' ? 'overdue' : 'pending';
                const statusText = service.status === 'active' ? 'Akt√≠v' : 
                                  service.status === 'suspended' ? 'Felf√ºggesztve' : 'Inakt√≠v';
                
                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-server" style="color: #17a2b8;"></i>
                            ${service.name || 'Szolg√°ltat√°s'}
                        </div>
                    </div>
                    <div class="card-subtitle">${service.description || 'Nincs le√≠r√°s'}</div>
                    <div style="margin-top: 15px;">
                        <span class="status ${statusClass}">${statusText}</span>
                        <div style="margin-top: 10px; color: #6c757d; font-size: 14px;">
                            Felhaszn√°l√≥: ${service.userEmail}
                        </div>
                        <div style="margin-top: 5px; color: #6c757d; font-size: 14px;">
                            Havi d√≠j: ${(service.monthlyPrice || 0).toLocaleString('hu-HU')} Ft
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // T√°mogat√°si jegyek bet√∂lt√©se
        async function loadAllTickets() {
            try {
                const snapshot = await db.collection('tickets').orderBy('createdAt', 'desc').get();
                allTickets = [];
                
                for (const doc of snapshot.docs) {
                    const ticket = { id: doc.id, ...doc.data() };
                    
                    let user = allUsers.find(u => u.id === ticket.userId);
                    if (!user) {
                        // Ha nem tal√°ljuk a felhaszn√°l√≥t a cache-ben, k√©rj√ºk le k√∂zvetlen√ºl
                        try {
                            const userDoc = await db.collection('users').doc(ticket.userId).get();
                            if (userDoc.exists) {
                                user = { id: userDoc.id, ...userDoc.data() };
                            }
                        } catch (error) {
                            console.error('Felhaszn√°l√≥ lek√©r√©si hiba:', error);
                        }
                    }
                    ticket.userEmail = user?.email || 'Ismeretlen';
                    
                    allTickets.push(ticket);
                }
                
                displayTickets(allTickets);
                console.log('üé´ Jegyek bet√∂ltve:', allTickets.length);
            } catch (error) {
                console.error('Jegyek bet√∂lt√©si hiba:', error);
            }
        }
        
        // T√°mogat√°si jegyek megjelen√≠t√©se
        function displayTickets(tickets) {
            const tableBody = document.getElementById('allTicketsTable');
            tableBody.innerHTML = '';
            
            tickets.forEach(ticket => {
                const row = document.createElement('tr');
                
                const priorityClass = ticket.priority === 'urgent' ? 'overdue' : 
                                     ticket.priority === 'high' ? 'pending' : 'paid';
                const priorityText = ticket.priority === 'urgent' ? 'S√ºrg≈ës' : 
                                    ticket.priority === 'high' ? 'Magas' : 'Norm√°l';
                
                const statusClass = ticket.status === 'open' ? 'overdue' : 
                                   ticket.status === 'in_progress' ? 'pending' : 'paid';
                const statusText = ticket.status === 'open' ? 'Nyitott' : 
                                  ticket.status === 'in_progress' ? 'Folyamatban' : 'Lez√°rt';
                
                const createdDate = ticket.createdAt ? 
                    new Date(ticket.createdAt.seconds * 1000).toLocaleDateString('hu-HU') : 'N/A';
                
                row.innerHTML = `
                    <td>#${ticket.ticketNumber || ticket.id.substring(0, 8)}</td>
                    <td>${ticket.userEmail}</td>
                    <td>${ticket.subject || 'Nincs t√°rgy'}</td>
                    <td><span class="status ${priorityClass}">${priorityText}</span></td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td>${createdDate}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="replyToTicket('${ticket.id}')">V√°lasz</button>
                        <button class="btn btn-sm btn-secondary" onclick="changeTicketStatus('${ticket.id}')">√Ållapot</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // Rendszer esem√©nyek bet√∂lt√©se 
        async function loadSystemEvents() {
            try {
                console.log('üîÑ Rendszer esem√©nyek bet√∂lt√©se kezd≈ëdik...');
                
                // Mivel 'date' mez≈ë string, nem tudjuk rendezni id≈ërendben
                // Ez√©rt egyszer≈± lek√©rdez√©st haszn√°lunk
                const snapshot = await db.collection('activities')
                    .limit(10) 
                    .get();
                
                console.log('üìä Lek√©rt dokumentumok sz√°ma:', snapshot.size);
                
                // Felhaszn√°l√≥k lek√©r√©se
                const usersSnapshot = await db.collection('users').get();
                const usersMap = {};
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    usersMap[doc.id] = userData.email || 'Email nem tal√°lhat√≥';
                });
                
                const events = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    console.log('üìÑ Dokumentum adatok:', data);
                    
                    const event = {
                        id: doc.id,
                        timestamp: {
                            seconds: data.date.seconds || data.date._seconds || (new Date(data.date).getTime() / 1000)
                        },
                        userEmail: data.userId ? (usersMap[data.userId] || 'Felhaszn√°l√≥ nem tal√°lhat√≥') : 'Rendszer',
                        event: data.description || data.type || 'Ismeretlen esem√©ny',
                        status: data.status === 'Nyitott' ? 'warning' : 
                               data.status === 'Lez√°rt' ? 'success' : 'pending'
                    };
                    
                    events.push(event);
                });
                
                // Rendez√©s d√°tum szerint (leg√∫jabb el≈ësz√∂r)
                events.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                
                // Csak az els≈ë 10-et tartjuk meg
                const limitedEvents = events.slice(0, 10);
                
                displaySystemEvents(limitedEvents);
                console.log('‚úÖ Rendszer esem√©nyek bet√∂ltve:', limitedEvents.length);
                
            } catch (error) {
                console.error('‚ùå Rendszer esem√©nyek bet√∂lt√©si hiba:', error);
                
                // Fallback adatok
                displaySystemEvents([
                    {
                        timestamp: { seconds: Date.now() / 1000 },
                        userEmail: 'system@bitnova.hu',
                        event: 'Rendszer ind√≠t√°s (fallback)',
                        status: 'success'
                    }
                ]);
            }
        }
        
        // Rendszer esem√©nyek megjelen√≠t√©se
        function displaySystemEvents(events) {
            const tableBody = document.getElementById('systemEventsTable');
            
            if (!tableBody) {
                console.error('‚ùå systemEventsTable elem nem tal√°lhat√≥!');
                return;
            }
            
            tableBody.innerHTML = '';
            
            events.forEach(event => {
                const row = document.createElement('tr');
                
                // Status class meghat√°roz√°sa
                const statusClass = event.status === 'success' ? 'paid' : 
                                   event.status === 'warning' ? 'pending' : 'overdue';
                const statusText = event.status === 'success' ? 'Sikeres' : 
                                  event.status === 'warning' ? 'Figyelmeztet√©s' : 
                                  event.status === 'pending' ? 'Folyamatban' : 'Hiba';
                
                // D√°tum form√°z√°sa
                const eventDate = event.timestamp ? 
                    new Date(event.timestamp.seconds * 1000).toLocaleString('hu-HU') : 'N/A';
                
                row.innerHTML = `
                    <td>${eventDate}</td>
                    <td>${event.userEmail || 'Rendszer'}</td>
                    <td>${event.event || 'Ismeretlen esem√©ny'}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                `;
                
                tableBody.appendChild(row);
            });
            
            console.log('üìã T√°bl√°zat friss√≠tve', events.length, 'esem√©nnyel');
        }

        // osszes aktivitas lekerese
        async function loadAllActivities() {
            try {
                console.log('üîÑ √ñsszes aktivit√°s bet√∂lt√©se (optimaliz√°lt)...');
                
                // P√°rhuzamosan lek√©rj√ºk az aktivit√°sokat √©s felhaszn√°l√≥kat
                const [activitiesSnapshot, usersSnapshot] = await Promise.all([
                    db.collection('activities').get(),
                    db.collection('users').get()
                ]);
                
                console.log('üìä Lek√©rt aktivit√°sok:', activitiesSnapshot.size);
                console.log('üë• Lek√©rt felhaszn√°l√≥k:', usersSnapshot.size);
                
                // Felhaszn√°l√≥k indexel√©se ID alapj√°n
                const usersMap = {};
                usersSnapshot.forEach(doc => {
                    const userData = doc.data();
                    usersMap[doc.id] = userData.email || 'Email nem tal√°lhat√≥';
                });
                
                const events = [];
                activitiesSnapshot.forEach(doc => {
                    const data = doc.data();
                    
                    // Felhaszn√°l√≥ email lek√©r√©se a map-b≈ël
                    const userEmail = data.userId ? 
                        (usersMap[data.userId] || 'Felhaszn√°l√≥ nem tal√°lhat√≥') : 
                        'Rendszer';
                    
                    // √Åtalak√≠tjuk a form√°tumot
                    const event = {
                        id: doc.id,
                        timestamp: {
                            seconds: data.date.seconds || data.date._seconds || (new Date(data.date).getTime() / 1000)
                        },
                        userEmail: userEmail,
                        event: data.description || data.type || 'Ismeretlen esem√©ny',
                        status: mapStatus(data.status),
                        originalData: data
                    };
                    
                    events.push(event);
                });
                
                // Rendez√©s d√°tum szerint (leg√∫jabb el≈ësz√∂r)
                events.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
                
                console.log('‚úÖ Aktivit√°sok rendezve:', events.length);
                displayAllActivities(events);
                
            } catch (error) {
                console.error('‚ùå Aktivit√°sok bet√∂lt√©si hiba:', error);
                
                const tableBody = document.getElementById('allActivitiesTable');
                if (tableBody) {
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="4" style="color: red; text-align: center;">
                                Hiba az aktivit√°sok bet√∂lt√©se sor√°n: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }
        
        // Status √°talak√≠t√≥ f√ºggv√©ny (v√°ltozatlan)
        function mapStatus(originalStatus) {
            if (!originalStatus) return 'warning';
            
            const status = originalStatus.toLowerCase();
            
            if (status.includes('nyitott') || status.includes('pending')) {
                return 'warning';
            } else if (status.includes('lez√°rt') || status.includes('sikeres') || status.includes('complete')) {
                return 'success';
            } else {
                return 'overdue';
            }
        }
        
        // √ñsszes aktivit√°s megjelen√≠t√©se - jav√≠tott verzi√≥
        function displayAllActivities(events) {
            const tableBody = document.getElementById('allActivitiesTable');
            
            if (!tableBody) {
                console.error('‚ùå allActivitiesTable elem nem tal√°lhat√≥!');
                return;
            }
            
            tableBody.innerHTML = '';
        
            if (events.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Nincs aktivit√°s az adatb√°zisban</td></tr>';
                return;
            }
        
            events.forEach((event, index) => {
                const row = document.createElement('tr');
        
                // D√°tum form√°z√°sa
                const date = event.timestamp ?
                    new Date(event.timestamp.seconds * 1000).toLocaleString('hu-HU', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : 'N/A';
        
                // Status oszt√°ly √©s sz√∂veg
                const statusClass = event.status === 'success' ? 'paid' :
                                   event.status === 'warning' ? 'pending' : 'overdue';
        
                const statusText = event.status === 'success' ? 'Sikeres' :
                                  event.status === 'warning' ? 'Folyamatban' : 'Probl√©ma';
        
                row.innerHTML = `
                    <td>${date}</td>
                    <td>${event.userEmail || 'Rendszer'}</td>
                    <td>${event.event || 'Ismeretlen esem√©ny'}</td>
                    <td><span class="status ${statusClass}">${statusText}</span></td>
                    <td><button class="btn btn-sm btn-delete" onclick="openDeleteActivityModal('${event.id}', '${date}', '${event.userEmail}', '${event.event}')">T√∂rl√©s</button></td>
                `;
        
                tableBody.appendChild(row);
                
                // Debug info konzolba (els≈ë 3 elemre)
                if (index < 3) {
                    console.log(`üìÑ Aktivit√°s ${index + 1}:`, {
                        date: date,
                        user: event.userEmail,
                        event: event.event,
                        status: event.status,
                        original: event.originalData
                    });
                }
            });
            
            console.log(`üìã T√°bl√°zat felt√∂ltve ${events.length} aktivit√°ssal`);
        }

        // Aktivit√°s t√∂rl√©se
        // Modal megnyit√°sa
        function openDeleteActivityModal(activityId, date, userEmail, event) {
            document.getElementById('deleteActivityDate').textContent = date;
            document.getElementById('deleteActivityUser').textContent = userEmail;
            document.getElementById('deleteActivityEvent').textContent = event;
            
            document.getElementById('confirmDeleteBtn').onclick = () => confirmDeleteActivity(activityId);
            document.getElementById('deleteActivityModal').style.display = 'block';
        }
        
        // Modal bez√°r√°sa
        function closeDeleteActivityModal() {
            document.getElementById('deleteActivityModal').style.display = 'none';
        }
        
        // T√∂rl√©s meger≈ës√≠t√©se
        async function confirmDeleteActivity(activityId) {
            try {
                console.log('üóëÔ∏è Aktivit√°s t√∂rl√©se:', activityId);
                
                await db.collection('activities').doc(activityId).delete();
                
                console.log('‚úÖ Aktivit√°s t√∂r√∂lve');
                closeDeleteActivityModal();
                loadAllActivities(); // T√°bl√°zat √∫jrat√∂lt√©se
                
            } catch (error) {
                console.error('‚ùå T√∂rl√©si hiba:', error);
                alert('Hiba t√∂rt√©nt a t√∂rl√©s sor√°n: ' + error.message);
            }
        }
       
        // Analitika bet√∂lt√©se
        async function loadAnalytics() {
            try {
                // Havi n√∂veked√©s sz√°m√≠t√°sa
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                
                const newUsersCount = allUsers.filter(user => 
                    user.createdAt && new Date(user.createdAt.seconds * 1000) > lastMonth
                ).length;
                
                // √Åtlag v√°laszid≈ë (p√©lda sz√°m√≠t√°s)
                const avgResponseTime = calculateAverageResponseTime();
                
                // √úgyf√©l el√©gedetts√©g (p√©lda √©rt√©k)
                const customerSatisfaction = 4.2;
                
                // Lemorzsol√≥d√°si ar√°ny (p√©lda sz√°m√≠t√°s)
                const churnRate = calculateChurnRate();
                
                updateAnalytics({
                    monthlyGrowth: newUsersCount,
                    avgResponseTime: avgResponseTime,
                    customerSatisfaction: customerSatisfaction,
                    churnRate: churnRate
                });
                
                loadTopServices();
                
            } catch (error) {
                console.error('Analitika bet√∂lt√©si hiba:', error);
            }
        }
        
        // Analitika megjelen√≠t√©se
        function updateAnalytics(data) {
            document.getElementById('monthlyGrowth').textContent = `+${data.monthlyGrowth}`;
            document.getElementById('avgResponseTime').textContent = `${data.avgResponseTime}h`;
            document.getElementById('customerSatisfaction').textContent = data.customerSatisfaction.toFixed(1);
            document.getElementById('churnRate').textContent = `${data.churnRate}%`;
        }
        
        // √Åtlag v√°laszid≈ë sz√°m√≠t√°sa
        function calculateAverageResponseTime() {
            // P√©lda sz√°m√≠t√°s - val√≥di implement√°ci√≥ban a tickets v√°laszideit sz√°moln√°nk
            return Math.floor(Math.random() * 24) + 1;
        }
        
        // Lemorzsol√≥d√°si ar√°ny sz√°m√≠t√°sa
        function calculateChurnRate() {
            // P√©lda sz√°m√≠t√°s
            const totalUsers = allUsers.length;
            const inactiveUsers = allUsers.filter(user => {
                const lastMonth = new Date();
                lastMonth.setMonth(lastMonth.getMonth() - 1);
                return user.lastLogin && new Date(user.lastLogin.seconds * 1000) < lastMonth;
            }).length;
            
            return totalUsers > 0 ? ((inactiveUsers / totalUsers) * 100).toFixed(1) : 0;
        }
        
        // Top szolg√°ltat√°sok bet√∂lt√©se
        function loadTopServices() {
            const serviceStats = {};
            
            allServices.forEach(service => {
                const serviceName = service.name || 'Ismeretlen szolg√°ltat√°s';
                if (!serviceStats[serviceName]) {
                    serviceStats[serviceName] = {
                        name: serviceName,
                        activeSubscribers: 0,
                        monthlyRevenue: 0
                    };
                }
                
                if (service.status === 'active') {
                    serviceStats[serviceName].activeSubscribers++;
                    serviceStats[serviceName].monthlyRevenue += service.monthlyPrice || 0;
                }
            });
            
            const topServices = Object.values(serviceStats)
                .sort((a, b) => b.monthlyRevenue - a.monthlyRevenue)
                .slice(0, 5);
            
            displayTopServices(topServices);
        }
        
        // Top szolg√°ltat√°sok megjelen√≠t√©se
        function displayTopServices(services) {
            const tableBody = document.getElementById('topServicesTable');
            tableBody.innerHTML = '';
            
            services.forEach(service => {
                const row = document.createElement('tr');
                const growth = Math.floor(Math.random() * 20) + 5; // P√©lda n√∂veked√©s
                
                row.innerHTML = `
                    <td>${service.name}</td>
                    <td>${service.activeSubscribers}</td>
                    <td>${service.monthlyRevenue.toLocaleString('hu-HU')} Ft</td>
                    <td><span class="status paid">+${growth}%</span></td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        // √Åttekint√©s statisztik√°k friss√≠t√©se
        function updateOverviewStats() {
            // √ñsszes felhaszn√°l√≥
            document.getElementById('totalUsers').textContent = allUsers.length;
            document.getElementById('usersSummary').textContent = `${allUsers.filter(u => u.stats?.services > 0).length} akt√≠v √ºgyf√©l`;
            
            // Havi bev√©tel
            const monthlyRevenue = allServices
                .filter(s => s.status === 'active')
                .reduce((sum, s) => sum + (s.monthlyPrice || 0), 0);
            document.getElementById('monthlyRevenue').textContent = `${monthlyRevenue.toLocaleString('hu-HU')} Ft`;
            
            // Akt√≠v jegyek
            const activeTickets = allTickets.filter(t => t.status !== 'closed').length;
            document.getElementById('activeTickets').textContent = activeTickets;
            document.getElementById('ticketsSummary').textContent = `${allTickets.filter(t => t.priority === 'urgent').length} s√ºrg≈ës`;
            
            // S√ºrg≈ës feladatok
            const urgentTasks = allTickets.filter(t => t.priority === 'urgent' && t.status !== 'closed').length;
            document.getElementById('urgentTasks').textContent = urgentTasks;
            document.getElementById('urgentSummary').textContent = urgentTasks > 0 ? 'Azonnali figyelmet ig√©nyel' : 'Nincs s√ºrg≈ës feladat';
        }
        
        // Navig√°ci√≥ kezel√©se
        function showSection(sectionId) {
            // √ñsszes szekci√≥ elrejt√©se
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('hidden');
            });
            
            // Akt√≠v szekci√≥ megjelen√≠t√©se
            document.getElementById(sectionId).classList.remove('hidden');
            
            // Navig√°ci√≥s elemek friss√≠t√©se
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            event.target.classList.add('active');
        }
        
        // Felhaszn√°l√≥ r√©szletek megjelen√≠t√©se
        async function showUserDetails(userId) {
            try {
                const user = allUsers.find(u => u.id === userId);
                if (!user) return;
                
                const userServices = allServices.filter(s => s.userId === userId);
                const userTickets = allTickets.filter(t => t.userId === userId);
                const userInvoices = allInvoices.filter(i => i.userId === userId);
                
                const modalContent = document.getElementById('userDetailsContent');
                modalContent.innerHTML = `
                    <div style="margin-bottom: 20px;">
                        <h4>Alapadatok</h4>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>C√©gn√©v:</strong> ${user.companyName || 'Nincs megadva'}</p>
                        <p><strong>Regisztr√°ci√≥:</strong> ${user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString('hu-HU') : 'N/A'}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>Statisztik√°k</h4>
                        <p><strong>Szolg√°ltat√°sok:</strong> ${userServices.length}</p>
                        <p><strong>Nyitott jegyek:</strong> ${userTickets.filter(t => t.status !== 'closed').length}</p>
                        <p><strong>√ñsszes sz√°mla:</strong> ${userInvoices.length}</p>
                        <p><strong>Havi k√∂lts√©g:</strong> ${user.stats?.monthlyCost?.toLocaleString('hu-HU') || 0} Ft</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4>Szolg√°ltat√°sok</h4>
                        ${userServices.length > 0 ? 
                            userServices.map(s => `<p>‚Ä¢ ${s.name} (${s.status})</p>`).join('') : 
                            '<p>Nincs szolg√°ltat√°s</p>'
                        }
                    </div>
                `;
                
                document.getElementById('userDetailsModal').style.display = 'block';
                
            } catch (error) {
                console.error('Felhaszn√°l√≥ r√©szletek hiba:', error);
            }
        }
        
        // Modal bez√°r√°sa
        function closeUserDetailsModal() {
            document.getElementById('userDetailsModal').style.display = 'none';
        }
        
        // Keres√©s a felhaszn√°l√≥k k√∂z√∂tt
        document.getElementById('userSearch').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const filteredUsers = allUsers.filter(user => 
                user.email?.toLowerCase().includes(searchTerm) ||
                user.companyName?.toLowerCase().includes(searchTerm)
            );
            displayUsers(filteredUsers);
        });
        
        // Sz√°ml√°k sz≈±r√©se
        function filterInvoices() {
            const statusFilter = document.getElementById('invoiceStatusFilter').value;
            const dateFrom = document.getElementById('invoiceDateFrom').value;
            const dateTo = document.getElementById('invoiceDateTo').value;
            
            let filteredInvoices = allInvoices;
            
            if (statusFilter) {
                filteredInvoices = filteredInvoices.filter(invoice => invoice.status === statusFilter);
            }
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filteredInvoices = filteredInvoices.filter(invoice => 
                    new Date(invoice.date.seconds * 1000) >= fromDate
                );
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                filteredInvoices = filteredInvoices.filter(invoice => 
                    new Date(invoice.date.seconds * 1000) <= toDate
                );
            }
            
            displayInvoices(filteredInvoices);
        }
        
        // Jegyek sz≈±r√©se
        function filterTickets() {
            const statusFilter = document.getElementById('ticketStatusFilter').value;
            const priorityFilter = document.getElementById('ticketPriorityFilter').value;
            
            let filteredTickets = allTickets;
            
            if (statusFilter) {
                filteredTickets = filteredTickets.filter(ticket => ticket.status === statusFilter);
            }
            
            if (priorityFilter) {
                filteredTickets = filteredTickets.filter(ticket => ticket.priority === priorityFilter);
            }
            
            displayTickets(filteredTickets);
        }
        
        // Felhaszn√°l√≥k export√°l√°sa
        function exportUsers() {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Email,C√©gn√©v,Regisztr√°ci√≥,Szolg√°ltat√°sok,Nyitott jegyek,Havi k√∂lts√©g\n"
                + allUsers.map(user => [
                    user.email || '',
                    user.companyName || '',
                    user.createdAt ? new Date(user.createdAt.seconds * 1000).toLocaleDateString('hu-HU') : '',
                    user.stats?.services || 0,
                    user.stats?.openTickets || 0,
                    user.stats?.monthlyCost || 0
                ].join(',')).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "felhasznalok.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Sz√°ml√°k m≈±veletek
        function viewInvoice(invoiceId) {
            showNotification(`Sz√°mla megtekint√©se: ${invoiceId}`, 'success');
            // Itt implement√°lhatod a sz√°mla r√©szletes megjelen√≠t√©s√©t
        }
        
        async function changeInvoiceStatus(invoiceId) {
            const newStatus = await showSelectModal('V√°lassza ki az √∫j st√°tuszt:', [
                {value: 'paid', text: 'Kifizetve'},
                {value: 'pending', text: 'F√ºgg≈ëben'},
                {value: 'overdue', text: 'Lej√°rt'}
            ], 'Sz√°mla st√°tusz m√≥dos√≠t√°sa');
            if (newStatus && ['paid', 'pending', 'overdue'].includes(newStatus)) {
                db.collection('invoices').doc(invoiceId).update({
                    status: newStatus
                }).then(() => {
                    console.log('Sz√°mla st√°tusz friss√≠tve');
                    loadAllInvoices();
                }).catch(error => {
                    console.error('St√°tusz friss√≠t√©si hiba:', error);
                });
            }
        }
        
        // Jegy m≈±veletek
        async function replyToTicket(ticketId) {
        const reply = await showTextareaModal('√çrjon v√°laszt a jegyre:', 'V√°lasz sz√∂vege...', 'V√°lasz k√ºld√©se');
        if (reply) {
            try {
                // Reply mez≈ë friss√≠t√©se a Firestore-ban
                await db.collection('tickets').doc(ticketId).update({
                    reply: reply,
                    status: 'in_progress', 
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
    
                showNotification(`V√°lasz k√ºldve: ${ticketId}`, 'success');
            } catch (error) {
                showNotification('Hiba t√∂rt√©nt a v√°lasz k√ºld√©sekor', 'error');
                console.error(error);
            }
        }
    }
        
        async function changeTicketStatus(ticketId) {
            const newStatus = await showSelectModal('V√°lassza ki az √∫j st√°tuszt:', [
                {value: 'open', text: 'Nyitott'},
                {value: 'in_progress', text: 'Folyamatban'},
                {value: 'closed', text: 'Lez√°rt'}
            ], 'Jegy st√°tusz m√≥dos√≠t√°sa');
            if (newStatus && ['open', 'in_progress', 'closed'].includes(newStatus)) {
                db.collection('tickets').doc(ticketId).update({
                    status: newStatus
                }).then(() => {
                    console.log('Jegy st√°tusz friss√≠tve');
                    loadAllTickets();
                }).catch(error => {
                    console.error('St√°tusz friss√≠t√©si hiba:', error);
                });
            }
        }
        
        // Be√°ll√≠t√°sok kezel√©se
        document.getElementById('systemSettingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const settings = {
                systemName: document.getElementById('systemName').value,
                adminEmail: document.getElementById('adminEmail').value,
                autoBackup: document.getElementById('autoBackup').checked,
                emailNotifications: document.getElementById('emailNotifications').checked,
                maintenanceMode: document.getElementById('maintenanceMode').checked
            };
            
            // Be√°ll√≠t√°sok ment√©se Firebase-be
            db.collection('system_settings').doc('general').set(settings)
                .then(() => {
                    showNotification(`Be√°ll√≠t√°sok mentve!`, 'success');
                })
                .catch(error => {
                    console.error('Be√°ll√≠t√°sok ment√©si hiba:', error);
                    showNotification(`Hiba a be√°ll√≠t√°sok ment√©sekor!`, 'success');
                });
        });
        
        // Val√≥s idej≈± friss√≠t√©sek be√°ll√≠t√°sa
        function setupRealTimeListeners() {
            // Felhaszn√°l√≥k v√°ltoz√°sainak figyel√©se
            db.collection('users').onSnapshot(() => {
                loadAllUsers();
            });
            
            // Jegyek v√°ltoz√°sainak figyel√©se
            db.collection('tickets').onSnapshot(() => {
                loadAllTickets();
                updateOverviewStats();
            });
            
            // Szolg√°ltat√°sok v√°ltoz√°sainak figyel√©se
            db.collection('services').onSnapshot(() => {
                loadAllServices();
                updateOverviewStats();
            });

            db.collection('activities').onSnapshot(() => {
                loadAllActivities();
            });
       
            console.log('üîÑ Val√≥s idej≈± figyel√©s be√°ll√≠tva');
        }
        
        // Modal-ok √°ltal√°nos kezel√©se
        window.onclick = function(event) {
            const modal = document.getElementById('userDetailsModal');
            if (event.target === modal) {
                modal.style.display = "none";
            }
        }

        // Modal kezel≈ë v√°ltoz√≥k
        let currentModalResolve = null;
        let currentModalReject = null;
        
        // √ârtes√≠t√©si modal megjelen√≠t√©se
        function showNotification(message, type = 'info', title = '√ârtes√≠t√©s') {
            const modal = document.getElementById('notificationModal');
            const titleEl = document.getElementById('notificationTitle');
            const messageEl = document.getElementById('notificationMessage');
            const iconEl = document.getElementById('notificationIcon');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            // Ikon be√°ll√≠t√°sa t√≠pus szerint
            let iconClass = '';
            switch(type) {
                case 'success':
                    iconClass = 'fas fa-check-circle success-icon';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-circle error-icon';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle warning-icon';
                    break;
                default:
                    iconClass = 'fas fa-info-circle' + (type === 'info' ? ' text-primary' : '');
            }
            
            iconEl.innerHTML = `<i class="${iconClass}"></i>`;
            modal.style.display = 'block';
        }
        
        function closeNotificationModal() {
            document.getElementById('notificationModal').style.display = 'none';
        }
        
        // Input modal megjelen√≠t√©se
        function showInputModal(message, placeholder = '', title = 'Adatok megad√°sa') {
            return new Promise((resolve, reject) => {
                currentModalResolve = resolve;
                currentModalReject = reject;
                
                const modal = document.getElementById('inputModal');
                const titleEl = document.getElementById('inputTitle');
                const messageEl = document.getElementById('inputMessage');
                const inputEl = document.getElementById('inputField');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                inputEl.placeholder = placeholder;
                inputEl.value = '';
                
                modal.style.display = 'block';
                inputEl.focus();
            });
        }
        
        function closeInputModal() {
            document.getElementById('inputModal').style.display = 'none';
            if (currentModalReject) {
                currentModalReject();
                currentModalReject = null;
                currentModalResolve = null;
            }
        }
        
        function confirmInput() {
            const value = document.getElementById('inputField').value;
            document.getElementById('inputModal').style.display = 'none';
            if (currentModalResolve) {
                currentModalResolve(value);
                currentModalResolve = null;
                currentModalReject = null;
            }
        }
        
        // Textarea modal megjelen√≠t√©se
        function showTextareaModal(message, placeholder = '', title = '√úzenet √≠r√°sa') {
            return new Promise((resolve, reject) => {
                currentModalResolve = resolve;
                currentModalReject = reject;
                
                const modal = document.getElementById('textareaModal');
                const titleEl = document.getElementById('textareaTitle');
                const messageEl = document.getElementById('textareaMessage');
                const textareaEl = document.getElementById('textareaField');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                textareaEl.placeholder = placeholder;
                textareaEl.value = '';
                
                modal.style.display = 'block';
                textareaEl.focus();
            });
        }
        
        function closeTextareaModal() {
            document.getElementById('textareaModal').style.display = 'none';
            if (currentModalReject) {
                currentModalReject();
                currentModalReject = null;
                currentModalResolve = null;
            }
        }
        
        function confirmTextarea() {
            const value = document.getElementById('textareaField').value;
            document.getElementById('textareaModal').style.display = 'none';
            if (currentModalResolve) {
                currentModalResolve(value);
                currentModalResolve = null;
                currentModalReject = null;
            }
        }
        
        // Select modal megjelen√≠t√©se
        function showSelectModal(message, options, title = 'V√°lasszon opci√≥t') {
            return new Promise((resolve, reject) => {
                currentModalResolve = resolve;
                currentModalReject = reject;
                
                const modal = document.getElementById('selectModal');
                const titleEl = document.getElementById('selectTitle');
                const messageEl = document.getElementById('selectMessage');
                const selectEl = document.getElementById('selectField');
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                
                // Opci√≥k felt√∂lt√©se
                selectEl.innerHTML = '<option value="">V√°lasszon...</option>';
                options.forEach(option => {
                    const optionEl = document.createElement('option');
                    optionEl.value = option.value;
                    optionEl.textContent = option.text;
                    selectEl.appendChild(optionEl);
                });
                
                modal.style.display = 'block';
                selectEl.focus();
            });
        }
        
        function closeSelectModal() {
            document.getElementById('selectModal').style.display = 'none';
            if (currentModalReject) {
                currentModalReject();
                currentModalReject = null;
                currentModalResolve = null;
            }
        }
        
        function confirmSelect() {
            const value = document.getElementById('selectField').value;
            document.getElementById('selectModal').style.display = 'none';
            if (currentModalResolve) {
                currentModalResolve(value);
                currentModalResolve = null;
                currentModalReject = null;
            }
        }
        
        // Enter lenyom√°s kezel√©se
        document.getElementById('inputField').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') confirmInput();
        });
        
        document.getElementById('textareaField').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.ctrlKey) confirmTextarea();
        });

        
    </script>
</body>
</html>
